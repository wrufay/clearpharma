<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClearPharma - Patient Dashboard</title>
  <link rel="stylesheet" href="https://i.icomoon.io/public/temp/92804d2d14/UntitledProject/style.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
  <link rel="stylesheet" href="style.css" />

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Hammersmith+One&family=Stack+Sans+Headline:wght@200..700&display=swap");

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #e8f4f8 0%, #f5f9fb 100%);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      background: white;
      font-family: "Stack Sans Headline", sans-serif;
      padding: 20px 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .welcome-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .welcome-text h1 {
      color: #2c5f6f;
      font-size: 24px;
      margin-bottom: 5px;
    }

    .welcome-text p {
      color: #7ba8b5;
      font-size: 14px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }

    /* Alert Banner */
    .alert-banner {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 15px;
    }

    .alert-banner.critical {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    }

    .alert-icon {
      font-size: 24px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-content strong {
      color: #2c5f6f;
      display: block;
      margin-bottom: 3px;
    }

    .alert-content p {
      color: #666;
      font-size: 14px;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .action-card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .action-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .action-label {
      color: #2c5f6f;
      font-size: 14px;
      font-weight: 600;
    }

    /* Card */
    .card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-header h3 {
      color: #2c5f6f;
      font-size: 18px;
      font-weight: 600;
    }

    .view-all {
      color: #5a9aae;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }

    .view-all:hover {
      text-decoration: underline;
    }

    /* Medication Item */
    .medication-item {
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 4px solid #5a9aae;
      background: #f8fbfc;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .medication-item:hover {
      background: #f0f8fa;
      transform: translateX(5px);
    }

    .medication-item.taken {
      border-left-color: #4caf50;
      opacity: 0.7;
    }

    .medication-item.missed {
      border-left-color: #f44336;
    }

    .med-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .med-name {
      font-weight: 600;
      color: #2c5f6f;
      font-size: 15px;
    }

    .med-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .med-status.upcoming {
      background: #e3f2fd;
      color: #2196f3;
    }

    .med-status.taken {
      background: #e8f5e9;
      color: #4caf50;
    }

    .med-status.missed {
      background: #ffebee;
      color: #f44336;
    }

    .med-dosage {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .med-time {
      color: #999;
      font-size: 13px;
    }

    /* Symptom Log */
    .symptom-item {
      padding: 12px 15px;
      background: #f8fbfc;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .symptom-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .symptom-type {
      font-weight: 600;
      color: #2c5f6f;
      font-size: 14px;
    }

    .symptom-severity {
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
    }

    .symptom-severity.mild {
      background: #e8f5e9;
      color: #4caf50;
    }

    .symptom-severity.moderate {
      background: #fff3e0;
      color: #ff9800;
    }

    .symptom-severity.severe {
      background: #ffebee;
      color: #f44336;
    }

    .symptom-description {
      color: #666;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .symptom-time {
      color: #999;
      font-size: 12px;
    }

    /* Symptom Action Buttons */
    .symptom-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .symptom-btn {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .symptom-btn-resolve {
      background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
      color: white;
    }

    .symptom-btn-resolve:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .symptom-btn-delete {
      background: #f44336;
      color: white;
    }

    .symptom-btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
    }

    .symptom-item.resolved {
      opacity: 0.6;
      background: #f0f0f0;
    }

    .symptom-item.resolved .symptom-type {
      text-decoration: line-through;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .metric-box {
      background: #f8fbfc;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .metric-value {
      font-size: 28px;
      font-weight: bold;
      color: #2c5f6f;
      margin-bottom: 5px;
    }

    .metric-label {
      color: #7ba8b5;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .metric-status {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .status-normal {
      background: #e8f5e9;
      color: #4caf50;
    }

    .status-warning {
      background: #fff3e0;
      color: #ff9800;
    }

    .status-critical {
      background: #ffebee;
      color: #f44336;
    }

    /* Chat Float Button */
    .chat-float {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      box-shadow: 0 4px 20px rgba(90, 154, 174, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-float:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(90, 154, 174, 0.5);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #7ba8b5;
      text-decoration: none;
      font-size: 12px;
      padding: 8px 20px;
      border-radius: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .nav-item.active {
      color: #5a9aae;
      background: #e8f4f8;
    }

    .nav-item:hover {
      background: #f0f8fa;
    }

    .nav-icon {
      font-size: 24px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #2c5f6f;
      font-size: 22px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #2c5f6f;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #5a9aae;
      box-shadow: 0 0 0 3px rgba(90, 154, 174, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(90, 154, 174, 0.3);
    }

    .modal-btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .modal-btn-secondary:hover {
      background: #e0e0e0;
    }

    /* Medication Logging Styles */
    .medication-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 24px;
      font-weight: bold;
      color: #2c5f6f;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8fbfc;
      padding: 8px 15px;
      border-radius: 25px;
    }

    .date-selector button {
      background: none;
      border: none;
      color: #5a9aae;
      font-size: 20px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .date-selector button:hover {
      background: #e8f4f8;
    }

    .date-selector span {
      font-weight: 600;
      color: #2c5f6f;
      min-width: 120px;
      text-align: center;
    }

    .medication-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .medication-card {
      background: linear-gradient(135deg, #f8fbfc 0%, #ffffff 100%);
      border-radius: 16px;
      padding: 20px;
      border-left: 5px solid #5a9aae;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .medication-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .medication-card.taken {
      border-left-color: #4caf50;
      background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);
      opacity: 0.8;
    }

    .medication-card.missed {
      border-left-color: #f44336;
      background: linear-gradient(135deg, #ffebee 0%, #ffffff 100%);
    }

    .medication-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .medication-info {
      flex: 1;
    }

    .medication-name {
      font-size: 18px;
      font-weight: 600;
      color: #2c5f6f;
      margin-bottom: 5px;
    }

    .medication-dosage {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .medication-time {
      font-size: 13px;
      color: #999;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .medication-status {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.pending {
      background: #fff3e0;
      color: #ff9800;
    }

    .status-badge.taken {
      background: #e8f5e9;
      color: #4caf50;
    }

    .status-badge.missed {
      background: #ffebee;
      color: #f44336;
    }

    .status-badge.skipped {
      background: #f5f5f5;
      color: #999;
    }

    .medication-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }

    .med-action-btn {
      flex: 1;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .med-action-btn.take {
      background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
      color: white;
    }

    .med-action-btn.take:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .med-action-btn.skip {
      background: #f5f5f5;
      color: #666;
    }

    .med-action-btn.skip:hover {
      background: #e0e0e0;
    }

    .med-action-btn.undo {
      background: #ff9800;
      color: white;
    }

    .med-action-btn.undo:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
    }

    .med-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .instructions-box {
      background: #e8f4f8;
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
      font-size: 13px;
      color: #2c5f6f;
      line-height: 1.5;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 18px;
      color: #666;
      margin-bottom: 10px;
    }

    .empty-state-subtext {
      font-size: 14px;
      color: #999;
    }

    .adherence-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 25px;
      padding-top: 25px;
      border-top: 2px solid #e0e0e0;
    }

    .adherence-stat {
      text-align: center;
      padding: 15px;
      background: #f8fbfc;
      border-radius: 12px;
    }

    .adherence-stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .adherence-stat-value.taken {
      color: #4caf50;
    }

    .adherence-stat-value.missed {
      color: #f44336;
    }

    .adherence-stat-value.rate {
      color: #5a9aae;
    }

    .adherence-stat-label {
      font-size: 13px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @media (max-width: 768px) {
      .medication-header {
        flex-direction: column;
        gap: 15px;
      }

      .medication-status {
        align-items: flex-start;
      }

      .medication-actions {
        flex-direction: column;
      }

      .adherence-summary {
        grid-template-columns: 1fr;
      }
    }


    /* AI Chat Styling */
    .chat-message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .chat-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .chat-message.ai .chat-avatar {
      background: linear-gradient(135deg, #2da6c4 0%, #0e6378 100%);
      color: white;
    }

    .chat-message.user .chat-avatar {
      background: #5a9aae;
      color: white;
    }

    .chat-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
    }

    .chat-message.ai .chat-bubble {
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .chat-message.user .chat-bubble {
      background: #5a9aae;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .typing-indicator {
      display: none;
      padding: 12px 16px;
      background: #f0f0f0;
      border-radius: 16px;
      width: fit-content;
      margin-bottom: 15px;
    }

    .typing-indicator.active {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        transform: translateY(0);
      }

      30% {
        transform: translateY(-10px);
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="welcome-section">
      <div class="welcome-text">
        <h1 id="welcomeText">Welcome back, Patient!</h1>
        <p id="dateText">Loading...</p>
      </div>
      <div style="display: flex; align-items: center; gap: 15px">
        <div class="user-avatar" id="userAvatar">P</div>
        <button onclick="logout()" style="
              padding: 8px 16px;
              background: #f44336;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            ">
          Logout
        </button>
      </div>
    </div>

    <!-- Alert Banner (shown only if there are alerts) -->
    <div id="alertBanner" style="display: none"></div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Quick Actions -->
    <div class="quick-actions">
      <div class="action-card" onclick="logSymptoms()">
        <div class="action-icon">
          <span class="icon-report-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span><span class="path38"></span><span
              class="path39"></span><span class="path40"></span><span class="path41"></span><span
              class="path42"></span><span class="path43"></span><span class="path44"></span><span
              class="path45"></span><span class="path46"></span><span class="path47"></span><span
              class="path48"></span><span class="path49"></span><span class="path50"></span></span>
        </div>
        <div class="action-label">Log Symptoms</div>
      </div>
      <div class="action-card" onclick="viewMedications()">
        <div class="action-icon">
          <span class="icon-lock-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span></span>
        </div>
        <div class="action-label">Medications</div>
      </div>
      <div class="action-card" onclick="requestConsultation()">
        <div class="action-icon">
          <span class="icon-personal-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span></span>
        </div>
        <div class="action-label">Consultation</div>
      </div>
      <div class="action-card" onclick="viewEducation()">
        <div class="action-icon">
          <span class="icon-bookmark-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span></span>
        </div>
        <div class="action-label">Education</div>
      </div>
    </div>

    <!-- Today's Medications -->

    <div class="medication-section">
      <div class="section-header">
        <h2 class="section-title">ðŸ’Š Today's Medications</h2>
        <div class="date-selector">
          <button onclick="changeDate(-1)">â—€</button>
          <span id="currentDate">Today</span>
          <button onclick="changeDate(1)">â–¶</button>
        </div>
      </div>

      <div id="medicationList" class="medication-list">
        <!-- Medications will be loaded here -->
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ’Š</div>
          <div class="empty-state-text">Loading your medications...</div>
        </div>
      </div>

      <div id="adherenceSummary" class="adherence-summary" style="display: none">
        <div class="adherence-stat">
          <div class="adherence-stat-value taken" id="takenCount">0</div>
          <div class="adherence-stat-label">Taken</div>
        </div>
        <div class="adherence-stat">
          <div class="adherence-stat-value missed" id="missedCount">0</div>
          <div class="adherence-stat-label">Missed</div>
        </div>
        <div class="adherence-stat">
          <div class="adherence-stat-value rate" id="adherenceRate">100%</div>
          <div class="adherence-stat-label">Adherence</div>
        </div>
      </div>
    </div>

    <!-- <div class="card">
        <div class="card-header">
          <h3>
            <span class="icon-lock-svgrepo-com"
              ><span class="path1"></span><span class="path2"></span
              ><span class="path3"></span><span class="path4"></span
              ><span class="path5"></span><span class="path6"></span
              ><span class="path7"></span><span class="path8"></span
              ><span class="path9"></span><span class="path10"></span
              ><span class="path11"></span><span class="path12"></span
              ><span class="path13"></span><span class="path14"></span
              ><span class="path15"></span><span class="path16"></span
              ><span class="path17"></span><span class="path18"></span
              ><span class="path19"></span><span class="path20"></span
              ><span class="path21"></span><span class="path22"></span
              ><span class="path23"></span><span class="path24"></span
              ><span class="path25"></span><span class="path26"></span
              ><span class="path27"></span><span class="path28"></span
              ><span class="path29"></span><span class="path30"></span
              ><span class="path31"></span><span class="path32"></span
              ><span class="path33"></span><span class="path34"></span
              ><span class="path35"></span><span class="path36"></span
              ><span class="path37"></span
            ></span>
            Today's Medications
          </h3>
          <a
            href="#"
            class="view-all"
            onclick="viewMedications(); return false;"
            >View All</a
          >
        </div> -->

    <!-- <div id="medicationsList">
          <p style="text-align: center; color: #999; padding: 20px">
            Loading medications...
          </p>
        </div>
      </div> -->

    <!-- Recent Symptom Logs -->
    <div class="card">
      <div class="card-header">
        <h3>
          <span class="icon-pen-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span></span>
          Recent Symptom Logs
        </h3>
        <a href="#" class="view-all" onclick="logSymptoms(); return false;">Log New</a>
      </div>

      <div id="symptomsList">
        <p style="text-align: center; color: #999; padding: 20px">
          No symptoms logged yet
        </p>
      </div>
    </div>
  </div>

  <!-- Chat Float Button -->
  <div class="chat-float" onclick="openChat()" title="Chat with AI Assistant">
    <span class="icon-information-svgrepo-com-1"><span class="path1"></span><span class="path2"></span><span
        class="path3"></span><span class="path4"></span><span class="path5"></span><span class="path6"></span><span
        class="path7"></span><span class="path8"></span><span class="path9"></span><span class="path10"></span><span
        class="path11"></span><span class="path12"></span><span class="path13"></span><span class="path14"></span><span
        class="path15"></span><span class="path16"></span><span class="path17"></span><span class="path18"></span><span
        class="path19"></span><span class="path20"></span><span class="path21"></span><span class="path22"></span><span
        class="path23"></span><span class="path24"></span><span class="path25"></span><span class="path26"></span><span
        class="path27"></span><span class="path28"></span><span class="path29"></span><span class="path30"></span><span
        class="path31"></span><span class="path32"></span><span class="path33"></span><span class="path34"></span><span
        class="path35"></span></span>
  </div>


  <!-- Log Symptoms Modal -->
  <div id="symptomsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Log Symptoms</h2>
        <button class="modal-close" onclick="closeModal('symptomsModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Symptom Type</label>
          <input type="text" id="symptomType" placeholder="e.g., Headache, Nausea, Dizziness" />
        </div>
        <div class="form-group">
          <label>Severity</label>
          <select id="symptomSeverity">
            <option value="mild">Mild</option>
            <option value="moderate">Moderate</option>
            <option value="severe">Severe</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="symptomDescription" placeholder="Please describe what you're experiencing..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('symptomsModal')">
          Cancel
        </button>
        <button class="modal-btn modal-btn-primary" onclick="submitSymptom()">
          Log Symptom
        </button>
      </div>
    </div>
  </div>

  <!-- View Medications Modal -->
  <div id="medicationsModal" class="modal">
    <div class="modal-content" style="max-width: 600px">
      <div class="modal-header">
        <h2>
          <span class="icon-subscription-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span></span>
          My Medications
        </h2>
        <button class="modal-close" onclick="closeModal('medicationsModal')">
          &times;
        </button>
      </div>
      <div class="modal-body" id="medicationsContent">
        <p>Loading medications...</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('medicationsModal')">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Request Consultation Modal -->
  <div id="consultationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Request Consultation</h2>
        <button class="modal-close" onclick="closeModal('consultationModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Reason for Consultation</label>
          <select id="consultReason">
            <option value="medication-question">Medication Question</option>
            <option value="side-effects">Side Effects</option>
            <option value="dosage-concern">Dosage Concern</option>
            <option value="refill">Refill Request</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Details</label>
          <textarea id="consultDetails" placeholder="Please describe your concern or question..." rows="5"></textarea>
        </div>
        <div class="form-group">
          <label>Preferred Contact Method</label>
          <select id="consultContact">
            <option value="message">Message</option>
            <option value="phone">Phone Call</option>
            <option value="video">Video Call</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('consultationModal')">
          Cancel
        </button>
        <button class="modal-btn modal-btn-primary" onclick="submitConsultation()">
          Submit Request
        </button>
      </div>
    </div>
  </div>

  <!-- Education Resources Modal -->
  <div id="educationModal" class="modal">
    <div class="modal-content" style="max-width: 700px">
      <div class="modal-header">
        <h2>
          <span class="icon-forward-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span><span class="path38"></span></span>Education Resources
        </h2>
        <button class="modal-close" onclick="closeModal('educationModal')">
          &times;
        </button>
      </div>
      <div class="modal-body" id="educationContent">
        <div style="line-height: 1.8">
          <h3 style="color: #2c5f6f; margin-bottom: 15px">
            Medication Education
          </h3>
          <div style="
                background: #f8fbfc;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 15px;
              ">
            <h4 style="color: #5a9aae; margin-bottom: 10px">
              Understanding Your Medications
            </h4>
            <p style="color: #666; font-size: 14px">
              Learn about how your medications work, potential side effects,
              and best practices for taking them.
            </p>
          </div>

          <h3 style="color: #2c5f6f; margin: 20px 0 15px">
            Condition Management
          </h3>
          <div style="
                background: #f8fbfc;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 15px;
              ">
            <h4 style="color: #5a9aae; margin-bottom: 10px">
              Living with Chronic Conditions
            </h4>
            <p style="color: #666; font-size: 14px">
              Tips and strategies for managing your chronic condition and
              improving quality of life.
            </p>
          </div>

          <h3 style="color: #2c5f6f; margin: 20px 0 15px">Lifestyle Tips</h3>
          <div style="
                background: #f8fbfc;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 15px;
              ">
            <h4 style="color: #5a9aae; margin-bottom: 10px">
              Healthy Habits
            </h4>
            <p style="color: #666; font-size: 14px">
              Diet, exercise, and lifestyle modifications that can complement
              your treatment plan.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('educationModal')">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Service Team Chat Modal -->
  <!-- AI Chat Modal -->
  <div id="aiChatModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh">
      <div class="modal-header">
        <h2>AI Health Assistant</h2>
        <button class="modal-close" onclick="closeModal('aiChatModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div id="chatMessages" style="
          height: 400px;
          overflow-y: auto;
          border: 2px solid #e0e0e0;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          background: #f8fbfc;
        ">
          <div class="chat-message ai">
            <div class="chat-avatar"></div>
            <div class="chat-bubble">
              Hello! I'm your AI health assistant. I can help answer questions about your medications, symptoms, and
              general health. How can I assist you today?
            </div>
          </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="form-group">
          <textarea id="chatMessageInput" placeholder="Type your message..." rows="3"
            onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('aiChatModal')">
          Close
        </button>
        <button class="modal-btn modal-btn-primary" onclick="sendChatMessage()">
          Send Message
        </button>
      </div>
    </div>
  </div>


  <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const GEMINI_API_KEY = "AIzaSyBOO1S1t1-myCAC3HEadXeCCDM9-DqtK1A";
    const GEMINI_MODEL = "gemini-2.0-flash-exp";

    const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: GEMINI_MODEL });

    const SYSTEM_PROMPT = `You are a helpful AI health assistant for ClearPharma, a medication management platform.

Your role is to:
- Provide helpful, accurate information about medications and health
- Be empathetic and professional
- Always remind users to consult with their healthcare provider for medical decisions
- Keep responses concise and actionable (2-3 paragraphs max)
- Never provide specific medical diagnoses or treatment plans
- Focus on medication adherence, general wellness, and education

Important: You are an AI assistant, not a replacement for healthcare professionals.`;

    let chatHistory = [];

    window.sendChatMessage = async function () {
      const messageInput = document.getElementById("chatMessageInput");
      const message = messageInput.value.trim();

      if (!message) {
        alert("Please enter a message");
        return;
      }

      addMessageToChat(message, "user");
      messageInput.value = "";

      const typingIndicator = document.getElementById("typingIndicator");
      typingIndicator.classList.add("active");

      try {
        const chatContext = SYSTEM_PROMPT + "\n\nConversation:\n" +
          chatHistory.map(msg => `${msg.role}: ${msg.content}`).join("\n") +
          `\nUser: ${message}\nAssistant:`;

        const result = await model.generateContent(chatContext);
        const response = await result.response;
        const aiMessage = response.text();

        typingIndicator.classList.remove("active");
        addMessageToChat(aiMessage, "ai");

        chatHistory.push({ role: "User", content: message });
        chatHistory.push({ role: "Assistant", content: aiMessage });

        if (chatHistory.length > 10) {
          chatHistory = chatHistory.slice(-10);
        }

      } catch (error) {
        console.error("Error calling Gemini API:", error);
        typingIndicator.classList.remove("active");
        addMessageToChat("Sorry, I'm having trouble connecting right now. Please try again in a moment.", "ai");
      }
    };

    function addMessageToChat(message, sender) {
      const chatContainer = document.getElementById("chatMessages");

      const messageDiv = document.createElement("div");
      messageDiv.className = `chat-message ${sender}`;

      const avatar = document.createElement("div");
      avatar.className = "chat-avatar";
      avatar.textContent = sender === "ai" ? "" : window.currentPatient?.name?.charAt(0) || "P";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.textContent = message;

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      chatContainer.appendChild(messageDiv);

      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    window.openChat = function () {
      openModal("aiChatModal");
    };
  </script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDwMTaAWC1crZgt-qYPA8coG_0ufUBpWBg",
      authDomain: "clearpharma-d267f.firebaseapp.com",
      projectId: "clearpharma-d267f",
      storageBucket: "clearpharma-d267f.firebasestorage.app",
      messagingSenderId: "163400096970",
      appId: "1:163400096970:web:cf0c6a3e0662823570a833",
      measurementId: "G-T0LF1E23E4",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentPatient = null;

    // Check if user is logged in and is a patient
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        currentPatientUser = user;

        // Get patient data
        const patientDoc = await db.collection("users").doc(user.uid).get();

        if (patientDoc.exists && patientDoc.data().role === "patient") {
          currentPatient = patientDoc.data();

          // Update UI with patient info
          document.getElementById(
            "welcomeText"
          ).textContent = `Welcome back, ${currentPatient.name || "Patient"
          }!`;

          // Set current date
          const today = new Date();
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          document.getElementById("dateText").textContent =
            today.toLocaleDateString("en-US", options);

          // Get initials for avatar
          const initials = (currentPatient.name || "PT")
            .split(" ")
            .map((n) => n[0])
            .join("")
            .toUpperCase();
          document.getElementById("userAvatar").textContent = initials;

          // Load dashboard data
          loadDashboardData();

          setupMedicationListener();
        } else {
          // Not a patient, redirect to login
          alert("Access denied. Patient account required.");
          window.location.href = "index.html";
        }
      } else {
        // Not logged in, redirect to login
        window.location.href = "index.html";
      }
    });

    // Load dashboard data
    async function loadDashboardData() {
      try {
        // Load medications
        // loadMedications();

        // Load symptoms
        loadSymptoms();

        // Load health metrics
        loadHealthMetrics();

        // Load upcoming events
        loadUpcomingEvents();

        // Check for alerts
        checkAlerts();
      } catch (error) {
        console.error("Error loading dashboard data:", error);
      }
    }

    // Resolve a symptom (marks it as resolved)
    async function resolveSymptom(symptomId) {
      if (!confirm("Mark this symptom as resolved?")) {
        return;
      }

      try {
        await db.collection("symptoms").doc(symptomId).update({
          resolved: true,
          resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
          resolvedBy: currentUser.uid,
        });

        // Show success message
        const successDiv = document.createElement("div");
        successDiv.style.cssText =
          "position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600;";
        successDiv.textContent = "âœ… Symptom marked as resolved!";
        document.body.appendChild(successDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

        // Reload symptoms
        setTimeout(() => {
          loadSymptoms();
        }, 500);
      } catch (error) {
        console.error("Error resolving symptom:", error);
        alert("Error resolving symptom: " + error.message);
      }
    }

    // Delete a symptom permanently
    async function deleteSymptom(symptomId) {
      if (
        !confirm(
          "Are you sure you want to delete this symptom? This cannot be undone."
        )
      ) {
        return;
      }

      try {
        await db.collection("symptoms").doc(symptomId).delete();

        // Show success message
        const successDiv = document.createElement("div");
        successDiv.style.cssText =
          "position: fixed; top: 20px; right: 20px; background: #ff9800; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600;";
        successDiv.textContent = "ðŸ—‘ï¸ Symptom deleted!";
        document.body.appendChild(successDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

        // Reload symptoms
        setTimeout(() => {
          loadSymptoms();
        }, 500);
      } catch (error) {
        console.error("Error deleting symptom:", error);
        alert("Error deleting symptom: " + error.message);
      }
    }

    // Load medications
    // async function loadMedications() {
    //   try {
    //     const medsSnapshot = await db
    //       .collection("medications")
    //       .where("patientId", "==", currentUser.uid)
    //       .limit(5)
    //       .get();

    //     const medicationsList = document.getElementById("medicationsList");

    //     if (medsSnapshot.empty) {
    //       medicationsList.innerHTML =
    //         '<p style="text-align: center; color: #999; padding: 20px;">No medications scheduled. Your pharmacist will add them soon!</p>';
    //       return;
    //     }

    //     medicationsList.innerHTML = "";

    //     medsSnapshot.forEach((doc) => {
    //       const med = doc.data();
    //       const medItem = document.createElement("div");
    //       medItem.className = `medication-item ${med.status || "upcoming"}`;

    //       const statusClass =
    //         med.status === "taken"
    //           ? "taken"
    //           : med.status === "missed"
    //           ? "missed"
    //           : "upcoming";
    //       const statusText =
    //         med.status === "taken"
    //           ? "Taken"
    //           : med.status === "missed"
    //           ? "Missed"
    //           : "Upcoming";

    //       medItem.innerHTML = `
    //                   <div class="med-header">
    //                       <div class="med-name">${
    //                         med.name || "Medication"
    //                       }</div>
    //                       <div class="med-status ${statusClass}">${statusText}</div>
    //                   </div>
    //                   <div class="med-dosage">${
    //                     med.dosage || "Standard dose"
    //                   }</div>
    //                   <div class="med-time">${formatTime(
    //                     med.scheduledTime
    //                   )}</div>
    //               `;

    //       medicationsList.appendChild(medItem);
    //     });
    //   } catch (error) {
    //     console.error("Error loading medications:", error);
    //     document.getElementById("medicationsList").innerHTML =
    //       '<p style="text-align: center; color: #999; padding: 20px;">No medications scheduled yet.</p>';
    //   }
    // }

    // Load symptoms
    // Load symptoms (FIXED - no orderBy to avoid index requirement)
    async function loadSymptoms() {
      try {
        const symptomsSnapshot = await db
          .collection("symptoms")
          .where("patientId", "==", currentUser.uid)
          .limit(10)
          .get();

        const symptomsList = document.getElementById("symptomsList");

        if (symptomsSnapshot.empty) {
          symptomsList.innerHTML =
            '<p style="text-align: center; color: #999; padding: 20px;">No symptoms logged yet</p>';
          return;
        }

        // Convert to array and sort manually
        const symptoms = [];
        symptomsSnapshot.forEach((doc) => {
          symptoms.push({ id: doc.id, ...doc.data() });
        });

        // Sort by loggedAt manually (most recent first)
        symptoms.sort((a, b) => {
          const dateA = a.loggedAt
            ? a.loggedAt.toDate
              ? a.loggedAt.toDate()
              : new Date(a.loggedAt)
            : new Date(0);
          const dateB = b.loggedAt
            ? b.loggedAt.toDate
              ? b.loggedAt.toDate()
              : new Date(b.loggedAt)
            : new Date(0);
          return dateB - dateA;
        });

        // Take only first 3
        const recentSymptoms = symptoms.slice(0, 3);

        symptomsList.innerHTML = "";

        recentSymptoms.forEach((symptom) => {
          const symptomItem = document.createElement("div");
          symptomItem.className = "symptom-item";

          symptomItem.innerHTML = `
  <div class="symptom-header">
      <div class="symptom-type">${symptom.type || "Symptom"}</div>
      <div class="symptom-severity ${symptom.severity || "mild"}">${symptom.severity || "Mild"
            }</div>
  </div>
  <div class="symptom-description">${symptom.description || "No description"
            }</div>
  <div class="symptom-time">${formatTimestamp(symptom.loggedAt)}</div>
  <div class="symptom-actions">
      <button class="symptom-btn symptom-btn-resolve" onclick="resolveSymptom('${symptom.id
            }')">
          âœ“ Resolve
      </button>
      <button class="symptom-btn symptom-btn-delete" onclick="deleteSymptom('${symptom.id
            }')">
          Ã— Delete
      </button>
  </div>
`;

          // Add resolved class if symptom is resolved
          if (symptom.resolved) {
            symptomItem.classList.add("resolved");
          }

          symptomsList.appendChild(symptomItem);
        });
      } catch (error) {
        console.error("Error loading symptoms:", error);
        document.getElementById("symptomsList").innerHTML =
          '<p style="text-align: center; color: #999; padding: 20px;">Error loading symptoms</p>';
      }
    }

    // Load health metrics
    async function loadHealthMetrics() {
      try {
        const metricsDoc = await db
          .collection("healthMetrics")
          .doc(currentUser.uid)
          .get();

        if (metricsDoc.exists) {
          const metrics = metricsDoc.data();

          // Update adherence
          if (metrics.adherence !== undefined) {
            document.getElementById(
              "adherenceValue"
            ).textContent = `${metrics.adherence}%`;
          }
        }

        // Update adherence from patient profile
        if (currentPatient.adherenceRate !== undefined) {
          document.getElementById(
            "adherenceValue"
          ).textContent = `${currentPatient.adherenceRate}%`;
        }
      } catch (error) {
        console.error("Error loading health metrics:", error);
      }
    }

    // Load upcoming events
    async function loadUpcomingEvents() {
      try {
        const eventsSnapshot = await db
          .collection("events")
          .where("patientId", "==", currentUser.uid)
          .where("date", ">=", new Date())
          .orderBy("date", "asc")
          .limit(3)
          .get();

        const eventsList = document.getElementById("upcomingEvents");

        if (eventsSnapshot.empty) {
          eventsList.innerHTML =
            '<p style="text-align: center; color: #999; padding: 20px;">No upcoming events</p>';
          return;
        }

        eventsList.innerHTML = "";

        eventsSnapshot.forEach((doc) => {
          const event = doc.data();
          const eventItem = document.createElement("div");
          eventItem.className = "medication-item";

          eventItem.innerHTML = `
                        <div class="med-name">${event.title || "Event"}</div>
                        <div class="med-dosage">${event.description || ""}</div>
                        <div class="med-time">${formatDate(event.date)}</div>
                    `;

          eventsList.appendChild(eventItem);
        });
      } catch (error) {
        console.error("Error loading events:", error);
      }
    }

    // Check for alerts
    async function checkAlerts() {
      try {
        // Check for missed medications
        const missedMeds = await db
          .collection("medications")
          .where("patientId", "==", currentUser.uid)
          .where("status", "==", "missed")
          .get();

        if (!missedMeds.empty) {
          const alertBanner = document.getElementById("alertBanner");
          alertBanner.className = "alert-banner critical";
          alertBanner.style.display = "flex";
          alertBanner.innerHTML = `
                        <div class="alert-icon">âš ï¸</div>
                        <div class="alert-content">
                            <strong>Missed Medication Alert</strong>
                            <p>You have ${missedMeds.size} missed medication(s). Please take them as soon as possible.</p>
                        </div>
                    `;
        }
      } catch (error) {
        console.error("Error checking alerts:", error);
      }
    }

    // Helper functions
    function formatTime(timestamp) {
      if (!timestamp) return "Time not set";
      const date = timestamp.toDate
        ? timestamp.toDate()
        : new Date(timestamp);
      return date.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
      });
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return "Unknown time";
      const date = timestamp.toDate
        ? timestamp.toDate()
        : new Date(timestamp);
      return (
        date.toLocaleDateString("en-US", { month: "short", day: "numeric" }) +
        " at " +
        date.toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
        })
      );
    }

    function formatDate(timestamp) {
      if (!timestamp) return "Date not set";
      const date = timestamp.toDate
        ? timestamp.toDate()
        : new Date(timestamp);
      return date.toLocaleDateString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric",
      });
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add("active");
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove("active");
    }

    // Action functions
    function logSymptoms() {
      openModal("symptomsModal");
    }

    async function submitSymptom() {
      const symptomType = document.getElementById("symptomType").value.trim();
      const severity = document.getElementById("symptomSeverity").value;
      const description = document
        .getElementById("symptomDescription")
        .value.trim();

      if (!symptomType) {
        alert("Please enter a symptom type");
        return;
      }

      try {
        // Save to Firestore with both server timestamp and local fallback
        await db.collection("symptoms").add({
          patientId: currentUser.uid,
          patientName: currentPatient.name || "Patient",
          pharmacistId: currentPatient.pharmacistId || null,
          type: symptomType,
          severity: severity,
          description: description || "",
          loggedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: new Date(), // Fallback timestamp for immediate display
        });

        // Clear form
        document.getElementById("symptomType").value = "";
        document.getElementById("symptomSeverity").value = "mild";
        document.getElementById("symptomDescription").value = "";

        closeModal("symptomsModal");

        // Show success message
        const successDiv = document.createElement("div");
        successDiv.style.cssText =
          "position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600;";
        successDiv.textContent = "âœ… Symptom logged successfully!";
        document.body.appendChild(successDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

        // Reload symptoms with a small delay
        setTimeout(() => {
          loadSymptoms();
        }, 500);
      } catch (error) {
        console.error("Error logging symptom:", error);
        alert("Error logging symptom: " + error.message);
      }
    }

    function viewMedications() {
      loadAllMedications();
      openModal("medicationsModal");
    }

    async function loadAllMedications() {
      try {
        const medsSnapshot = await db
          .collection("medications")
          .where("patientId", "==", currentUser.uid)
          .limit(30)
          .get();

        const medsContainer = document.getElementById("medicationsContent");

        if (medsSnapshot.empty) {
          medsContainer.innerHTML =
            '<p style="text-align: center; color: #999; padding: 20px;">No medications found. Your pharmacist will add them soon!</p>';
          return;
        }

        let medsHTML = '<div style="max-height: 500px; overflow-y: auto;">';
        medsSnapshot.forEach((doc) => {
          const med = doc.data();
          const statusClass =
            med.status === "taken"
              ? "taken"
              : med.status === "missed"
                ? "missed"
                : "upcoming";
          const statusText =
            med.status === "taken"
              ? "Taken"
              : med.status === "missed"
                ? "Missed"
                : "Upcoming";
          const statusColor =
            med.status === "taken"
              ? "#4caf50"
              : med.status === "missed"
                ? "#f44336"
                : "#2196f3";

          medsHTML += `
                        <div style="padding: 15px; background: #f8fbfc; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #2c5f6f; font-size: 15px;">${med.name || "Medication"
            }</div>
                                <div style="padding: 4px 12px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 12px; font-weight: 600;">${statusText}</div>
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">${med.dosage || "Standard dose"
            }</div>
                            <div style="color: #999; font-size: 13px;">${formatTime(
              med.scheduledTime
            )}</div>
                        </div>
                    `;
        });
        medsHTML += "</div>";

        medsContainer.innerHTML = medsHTML;
      } catch (error) {
        console.error("Error loading medications:", error);
        document.getElementById("medicationsContent").innerHTML =
          '<p style="text-align: center; color: #999; padding: 20px;">No medications found.</p>';
      }
    }

    function requestConsultation() {
      openModal("consultationModal");
    }

    async function submitConsultation() {
      const reason = document.getElementById("consultReason").value;
      const details = document.getElementById("consultDetails").value.trim();
      const contactMethod = document.getElementById("consultContact").value;

      if (!details) {
        alert("Please provide details about your consultation request");
        return;
      }

      try {
        await db.collection("consultations").add({
          patientId: currentUser.uid,
          patientName: currentPatient.name,
          pharmacistId: currentPatient.pharmacistId,
          reason: reason,
          details: details,
          contactMethod: contactMethod,
          status: "pending",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert(
          "âœ… Consultation request submitted!\n\nYour pharmacist or service team will respond soon."
        );

        // Clear form
        document.getElementById("consultDetails").value = "";
        closeModal("consultationModal");
      } catch (error) {
        console.error("Error submitting consultation:", error);
        alert("Error submitting consultation request. Please try again.");
      }
    }

    function viewEducation() {
      openModal("educationModal");
    }

    function openChat() {
      loadChatMessages();
      openModal("serviceTeamModal");
    }

    async function loadChatMessages() {
      try {
        const messagesSnapshot = await db
          .collection("serviceTeamMessages")
          .where("userId", "==", currentUser.uid)
          .orderBy("timestamp", "asc")
          .limit(50)
          .get();

        const chatContainer = document.getElementById("chatMessages");

        if (messagesSnapshot.empty) {
          chatContainer.innerHTML =
            '<p style="text-align: center; color: #999;">No messages yet. Start a conversation!</p>';
        } else {
          chatContainer.innerHTML = "";
          messagesSnapshot.forEach((doc) => {
            const msg = doc.data();
            const isUser = msg.senderId === currentUser.uid;
            const timestamp = msg.timestamp
              ? msg.timestamp.toDate
                ? msg.timestamp.toDate()
                : new Date(msg.timestamp)
              : new Date();

            const messageDiv = document.createElement("div");
            messageDiv.style.cssText = `
                            margin-bottom: 12px;
                            text-align: ${isUser ? "right" : "left"};
                        `;

            messageDiv.innerHTML = `
                            <div style="
                                display: inline-block;
                                max-width: 70%;
                                padding: 10px 15px;
                                background: ${isUser ? "#5a9aae" : "#f0f0f0"};
                                color: ${isUser ? "white" : "#333"};
                                border-radius: 12px;
                                text-align: left;
                            ">
                                <div style="font-size: 14px;">${msg.message
              }</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">
                                    ${timestamp.toLocaleTimeString()}
                                </div>
                            </div>
                        `;

            chatContainer.appendChild(messageDiv);
          });

          // Scroll to bottom
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      } catch (error) {
        console.error("Error loading messages:", error);
      }
    }

    async function sendChatMessage() {
      const messageInput = document.getElementById("chatMessageInput");
      const message = messageInput.value.trim();

      if (!message) {
        alert("Please enter a message");
        return;
      }

      try {
        await db.collection("serviceTeamMessages").add({
          userId: currentUser.uid,
          userName: currentPatient.name,
          userRole: "patient",
          senderId: currentUser.uid,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false,
        });

        messageInput.value = "";
        loadChatMessages();
      } catch (error) {
        console.error("Error sending message:", error);
        alert("Error sending message. Please try again.");
      }
    }

    // Logout function
    async function logout() {
      if (confirm("Are you sure you want to log out?")) {
        try {
          await auth.signOut();

          // Show logging out message
          const logoutDiv = document.createElement("div");
          logoutDiv.style.cssText =
            "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px 50px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;";
          logoutDiv.innerHTML =
            '<div style="font-size: 18px; color: #2c5f6f; font-weight: 600;">Logging out...</div>';
          document.body.appendChild(logoutDiv);

          setTimeout(() => {
            window.location.href = "index.html";
          }, 500);
        } catch (error) {
          console.error("Error logging out:", error);
          alert("Error logging out. Please try again.");
        }
      }
    }

    // PATIENT MEDICATION LOGGING JAVASCRIPT
    // Add these functions to your patient dashboard

    let currentViewDate = new Date();

    // Load medications for the selected date
    async function loadTodaysMedications() {
      try {
        const medicationList = document.getElementById("medicationList");

        if (!medicationList) {
          console.error("âŒ medicationList element not found!");
          return;
        }

        medicationList.innerHTML =
          '<div style="text-align: center; padding: 20px; color: #999;">Loading...</div>';

        const startOfDay = new Date(currentViewDate);
        startOfDay.setHours(0, 0, 0, 0);

        const endOfDay = new Date(currentViewDate);
        endOfDay.setHours(23, 59, 59, 999);

        console.log("ðŸ“… Loading medications for:", startOfDay.toDateString());

        if (!currentPatientUser || !currentPatientUser.uid) {
          medicationList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš ï¸</div>
          <div class="empty-state-text">Please log in to view medications</div>
        </div>
      `;
          return;
        }

        // Get all active medications
        const medicationsSnapshot = await db
          .collection("medications")
          .where("patientId", "==", currentPatientUser.uid)
          .where("active", "==", true)
          .get();

        console.log(
          "ðŸ’Š Found",
          medicationsSnapshot.size,
          "active medications"
        );

        if (medicationsSnapshot.empty) {
          medicationList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ’Š</div>
          <div class="empty-state-text">No medications prescribed yet</div>
          <div class="empty-state-subtext">Your pharmacist will add medications for you</div>
        </div>
      `;
          return;
        }

        medicationList.innerHTML = "";

        let takenCount = 0;
        let missedCount = 0;
        let totalCount = 0;
        let medicationsNeedingDoses = [];

        // First pass - collect all doses and identify missing ones
        for (const medDoc of medicationsSnapshot.docs) {
          const medication = medDoc.data();
          const medId = medDoc.id;

          const dosesSnapshot = await db
            .collection("scheduledDoses")
            .where("medicationId", "==", medId)
            .where("scheduledTime", ">=", startOfDay)
            .where("scheduledTime", "<=", endOfDay)
            .orderBy("scheduledTime", "asc")
            .get();

          // Only create doses if we're viewing today AND no doses exist
          if (dosesSnapshot.empty && isToday(currentViewDate)) {
            medicationsNeedingDoses.push({ medId, medication });
          } else {
            // Display existing doses
            dosesSnapshot.forEach((doseDoc) => {
              const dose = doseDoc.data();
              const doseId = doseDoc.id;
              totalCount++;

              if (dose.status === "taken") takenCount++;
              if (dose.status === "missed") missedCount++;

              const card = createMedicationCard(
                medication,
                dose,
                doseId,
                medId
              );
              medicationList.appendChild(card);
            });
          }
        }

        // Second pass - create missing doses (only once!)
        if (medicationsNeedingDoses.length > 0) {
          console.log(
            `ðŸ”¨ Need to create doses for ${medicationsNeedingDoses.length} medication(s)`
          );

          // Create all missing doses
          for (const item of medicationsNeedingDoses) {
            await createDosesForToday(item.medId, item.medication);
          }

          // Reload ONCE after creating doses
          console.log("ðŸ”„ Reloading after creating doses...");
          setTimeout(() => {
            loadTodaysMedications();
          }, 500);
          return; // Exit to prevent duplicate rendering
        }

        // Update adherence summary
        const adherenceSummary = document.getElementById("adherenceSummary");
        if (adherenceSummary && totalCount > 0) {
          adherenceSummary.style.display = "grid";

          const takenCountEl = document.getElementById("takenCount");
          const missedCountEl = document.getElementById("missedCount");
          const adherenceRateEl = document.getElementById("adherenceRate");

          if (takenCountEl) takenCountEl.textContent = takenCount;
          if (missedCountEl) missedCountEl.textContent = missedCount;
          if (adherenceRateEl) {
            const adherenceRate =
              totalCount > 0
                ? Math.round((takenCount / totalCount) * 100)
                : 100;
            adherenceRateEl.textContent = adherenceRate + "%";
          }
        }

        console.log(`âœ… Loaded ${totalCount} doses for today`);
      } catch (error) {
        console.error("âŒ Error loading medications:", error);
        const medicationList = document.getElementById("medicationList");
        if (medicationList) {
          medicationList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš ï¸</div>
          <div class="empty-state-text">Error loading medications</div>
          <div class="empty-state-subtext">${error.message}</div>
        </div>
      `;
        }
      }
    }

    // CLEANUP FUNCTION: Delete duplicate doses (run this once to clean up)
    async function cleanupDuplicateDoses() {
      console.log("ðŸ§¹ Starting cleanup of duplicate doses...");

      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        // Get all doses for today
        const dosesSnapshot = await db
          .collection("scheduledDoses")
          .where("scheduledTime", ">=", today)
          .where("scheduledTime", "<", tomorrow)
          .get();

        console.log(`Found ${dosesSnapshot.size} total doses for today`);

        // Group doses by medication and time
        const doseGroups = {};

        dosesSnapshot.forEach((doc) => {
          const dose = doc.data();
          const key = `${dose.medicationId}_${dose.scheduledTime
            .toDate()
            .getTime()}`;

          if (!doseGroups[key]) {
            doseGroups[key] = [];
          }
          doseGroups[key].push({ id: doc.id, data: dose });
        });

        // Find and delete duplicates
        let deletedCount = 0;
        const batch = db.batch();

        Object.keys(doseGroups).forEach((key) => {
          const doses = doseGroups[key];

          if (doses.length > 1) {
            console.log(`Found ${doses.length} duplicates for key ${key}`);

            // Keep the first one, delete the rest
            for (let i = 1; i < doses.length; i++) {
              batch.delete(db.collection("scheduledDoses").doc(doses[i].id));
              deletedCount++;
            }
          }
        });

        if (deletedCount > 0) {
          await batch.commit();
          console.log(`âœ… Deleted ${deletedCount} duplicate doses`);
          alert(`Cleanup complete! Deleted ${deletedCount} duplicate doses.`);
        } else {
          console.log("âœ… No duplicates found");
          alert("No duplicates found. All good!");
        }

        // Reload medications
        loadTodaysMedications();
      } catch (error) {
        console.error("âŒ Error during cleanup:", error);
        alert("Error during cleanup: " + error.message);
      }
    }

    // Create medication card element
    function createMedicationCard(medication, dose, doseId, medId) {
      const card = document.createElement("div");
      card.className = `medication-card ${dose.status}`;

      const scheduledTime = dose.scheduledTime.toDate
        ? dose.scheduledTime.toDate()
        : new Date(dose.scheduledTime);
      const timeString = scheduledTime.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
      });

      const isPast = scheduledTime < new Date();
      const canTake = dose.status === "pending" && !isPast;
      const canUndo = dose.status === "taken" && isToday(currentViewDate);

      let statusBadge = "";
      let actionButtons = "";

      // Status badge
      if (dose.status === "taken") {
        statusBadge = '<div class="status-badge taken">âœ“ Taken</div>';
      } else if (dose.status === "missed") {
        statusBadge = '<div class="status-badge missed">âœ— Missed</div>';
      } else if (dose.status === "skipped") {
        statusBadge = '<div class="status-badge skipped">âŠ˜ Skipped</div>';
      } else if (isPast) {
        statusBadge = '<div class="status-badge missed">âš  Overdue</div>';
      } else {
        statusBadge = '<div class="status-badge pending">â—· Pending</div>';
      }

      // Action buttons
      if (canTake) {
        actionButtons = `
      <button class="med-action-btn take" onclick="markAsTaken('${doseId}', '${medId}')">
        âœ“ Take Now
      </button>
      <button class="med-action-btn skip" onclick="markAsSkipped('${doseId}')">
        Skip
      </button>
    `;
      } else if (canUndo) {
        actionButtons = `
      <button class="med-action-btn undo" onclick="undoTaken('${doseId}')">
        â†¶ Undo
      </button>
    `;
      } else if (isPast && dose.status === "pending") {
        actionButtons = `
      <button class="med-action-btn take" onclick="markAsTaken('${doseId}', '${medId}')">
        âœ“ Mark as Taken
      </button>
      <button class="med-action-btn skip" onclick="markAsMissed('${doseId}')">
        Mark as Missed
      </button>
    `;
      }

      card.innerHTML = `
    <div class="medication-header">
      <div class="medication-info">
        <div class="medication-name">${medication.name}</div>
        <div class="medication-dosage">${medication.dosage
        } - ${medication.frequency.replace(/-/g, " ")}</div>
        <div class="medication-time">â° ${timeString}</div>
      </div>
      <div class="medication-status">
        ${statusBadge}
      </div>
    </div>
    ${medication.instructions
          ? `<div class="instructions-box">ðŸ“‹ ${medication.instructions}</div>`
          : ""
        }
    ${actionButtons
          ? `<div class="medication-actions">${actionButtons}</div>`
          : ""
        }
  `;

      return card;
    }

    // Mark dose as taken
    async function markAsTaken(doseId, medId) {
      try {
        const now = new Date();

        // Update dose status
        await db.collection("scheduledDoses").doc(doseId).update({
          status: "taken",
          takenAt: firebase.firestore.FieldValue.serverTimestamp(),
          actualTakeTime: now,
        });

        // Update medication adherence tracking
        await updateMedicationAdherence(medId);

        // Show success feedback
        showToast("âœ“ Medication marked as taken!", "success");

        // Reload medications
        loadTodaysMedications();
      } catch (error) {
        console.error("Error marking as taken:", error);
        showToast("Error updating medication status", "error");
      }
    }

    // Mark dose as skipped
    async function markAsSkipped(doseId) {
      try {
        await db.collection("scheduledDoses").doc(doseId).update({
          status: "skipped",
          skippedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        showToast("Medication skipped", "info");
        loadTodaysMedications();
      } catch (error) {
        console.error("Error marking as skipped:", error);
        showToast("Error updating medication status", "error");
      }
    }

    // Mark dose as missed
    async function markAsMissed(doseId) {
      try {
        await db.collection("scheduledDoses").doc(doseId).update({
          status: "missed",
        });

        showToast("Marked as missed", "info");
        loadTodaysMedications();
      } catch (error) {
        console.error("Error marking as missed:", error);
      }
    }

    // Undo taken status
    async function undoTaken(doseId) {
      try {
        await db.collection("scheduledDoses").doc(doseId).update({
          status: "pending",
          takenAt: null,
          actualTakeTime: null,
        });

        showToast("Status reset to pending", "info");
        loadTodaysMedications();
      } catch (error) {
        console.error("Error undoing:", error);
        showToast("Error updating medication status", "error");
      }
    }

    // Update medication adherence tracking
    async function updateMedicationAdherence(medId) {
      try {
        const dosesSnapshot = await db
          .collection("scheduledDoses")
          .where("medicationId", "==", medId)
          .get();

        let totalDoses = 0;
        let takenDoses = 0;
        let missedDoses = 0;

        dosesSnapshot.forEach((doc) => {
          const dose = doc.data();
          totalDoses++;
          if (dose.status === "taken") takenDoses++;
          if (dose.status === "missed") missedDoses++;
        });

        const adherenceRate =
          totalDoses > 0 ? Math.round((takenDoses / totalDoses) * 100) : 100;

        await db.collection("medications").doc(medId).update({
          "adherenceTracking.totalDoses": totalDoses,
          "adherenceTracking.takenDoses": takenDoses,
          "adherenceTracking.missedDoses": missedDoses,
          "adherenceTracking.adherenceRate": adherenceRate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        // Update patient's overall adherence
        await updatePatientAdherence();
      } catch (error) {
        console.error("Error updating adherence:", error);
      }
    }

    // Update patient's overall adherence rate
    async function updatePatientAdherence() {
      try {
        const medsSnapshot = await db
          .collection("medications")
          .where("patientId", "==", currentPatientUser.uid)
          .where("active", "==", true)
          .get();

        let totalAdherence = 0;
        let medCount = 0;

        medsSnapshot.forEach((doc) => {
          const med = doc.data();
          if (
            med.adherenceTracking &&
            med.adherenceTracking.adherenceRate !== undefined
          ) {
            totalAdherence += med.adherenceTracking.adherenceRate;
            medCount++;
          }
        });

        const overallAdherence =
          medCount > 0 ? Math.round(totalAdherence / medCount) : 100;

        await db.collection("users").doc(currentPatientUser.uid).update({
          adherenceRate: overallAdherence,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      } catch (error) {
        console.error("Error updating patient adherence:", error);
      }
    }

    // Create doses for today if they don't exist
    async function createDosesForToday(medId, medication) {
      try {
        console.log(
          "ðŸ” Checking if doses already exist for medication:",
          medication.name
        );

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        // IMPORTANT: Check if doses already exist for today
        const existingDosesCheck = await db
          .collection("scheduledDoses")
          .where("medicationId", "==", medId)
          .where("scheduledTime", ">=", today)
          .where("scheduledTime", "<", tomorrow)
          .get();

        if (!existingDosesCheck.empty) {
          console.log("âœ… Doses already exist for today, skipping creation");
          return; // Don't create duplicates!
        }

        console.log("ðŸ“… Creating new doses for today...");

        const batch = db.batch();
        let doseCount = 0;

        medication.times.forEach((time) => {
          const [hours, minutes] = time.split(":");
          const scheduledTime = new Date(today);
          scheduledTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

          const doseRef = db.collection("scheduledDoses").doc();
          batch.set(doseRef, {
            medicationId: medId,
            patientId: medication.patientId,
            pharmacistId: medication.pharmacistId,
            medicationName: medication.name,
            dosage: medication.dosage,
            scheduledTime: scheduledTime,
            status: "pending",
            takenAt: null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          doseCount++;
        });

        await batch.commit();
        console.log(`âœ… Created ${doseCount} doses for ${medication.name}`);
      } catch (error) {
        console.error("âŒ Error creating doses:", error);
      }
    }

    // Change date view
    function changeDate(days) {
      currentViewDate.setDate(currentViewDate.getDate() + days);
      updateDateDisplay();
      loadTodaysMedications();
    }

    // Update date display
    function updateDateDisplay() {
      const dateSpan = document.getElementById("currentDate");

      if (isToday(currentViewDate)) {
        dateSpan.textContent = "Today";
      } else if (isYesterday(currentViewDate)) {
        dateSpan.textContent = "Yesterday";
      } else if (isTomorrow(currentViewDate)) {
        dateSpan.textContent = "Tomorrow";
      } else {
        dateSpan.textContent = currentViewDate.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }
    }

    // Helper functions
    function isToday(date) {
      const today = new Date();
      return date.toDateString() === today.toDateString();
    }

    function isYesterday(date) {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return date.toDateString() === yesterday.toDateString();
    }

    function isTomorrow(date) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      return date.toDateString() === tomorrow.toDateString();
    }

    // Show toast notification
    function showToast(message, type = "info") {
      // Use SweetAlert toast or create simple toast
      const toast = document.createElement("div");
      toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === "success" ? "#4caf50" : type === "error" ? "#f44336" : "#5a9aae"
        };
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
  `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = "slideOut 0.3s ease-out";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Set up real-time listener for medication updates
    function setupMedicationListener() {
      if (!currentPatientUser) return;

      db.collection("medications")
        .where("patientId", "==", currentPatientUser.uid)
        .where("active", "==", true)
        .onSnapshot(() => {
          // Only reload if viewing today AND not the initial load
          if (isToday(currentViewDate)) {
            console.log("ðŸ”„ Medication change detected, reloading...");
            loadTodaysMedications();
          }
        });
    }

    // Add CSS animations
    const style = document.createElement("style");
    style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
`;
    document.head.appendChild(style);
  </script>
</body>

</html>
