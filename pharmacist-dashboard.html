<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClearPharma - Pharmacist Dashboard</title>
  <link rel="stylesheet" href="https://i.icomoon.io/public/temp/92804d2d14/UntitledProject/style.css" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>
  <link rel="stylesheet" href="style.css" />

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Hammersmith+One&family=Stack+Sans+Headline:wght@200..700&display=swap");

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Hammersmith One", sans-serif;
      font-weight: 400;
      font-style: normal;
      background: linear-gradient(135deg, #e8f4f8 0%, #f5f9fb 100%);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      background: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      font-weight: bold;
    }

    .logo-text h1 {
      color: #2c5f6f;
      font-size: 24px;
      margin-bottom: 2px;
    }

    .logo-text span {
      color: #7ba8b5;
      font-size: 12px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .search-bar {
      position: relative;
      width: 400px;
    }

    .search-bar input {
      width: 100%;
      padding: 12px 45px 12px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #5a9aae;
      box-shadow: 0 0 0 3px rgba(90, 154, 174, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-details {
      text-align: right;
    }

    .user-details p {
      color: #2c5f6f;
      font-weight: 600;
      font-size: 14px;
    }

    .user-details span {
      color: #7ba8b5;
      font-size: 12px;
    }

    .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .stat-card.blue .stat-icon {
      background: #e3f2fd;
      color: #2196f3;
    }

    .stat-card.red .stat-icon {
      background: #ffebee;
      color: #f44336;
    }

    .stat-card.green .stat-icon {
      background: #e8f5e9;
      color: #4caf50;
    }

    .stat-card.orange .stat-icon {
      background: #fff3e0;
      color: #ff9800;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #2c5f6f;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #7ba8b5;
      font-size: 14px;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      color: white;
    }

    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(90, 154, 174, 0.3);
    }

    .action-btn.secondary {
      background: white;
      color: #5a9aae;
      border: 2px solid #5a9aae;
    }

    .action-btn.secondary:hover {
      background: #f0f8fa;
    }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }

    /* Risk Alerts */
    .section-card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #2c5f6f;
    }

    .view-all {
      color: #5a9aae;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }

    .view-all:hover {
      text-decoration: underline;
    }

    .alert-item {
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .alert-item:hover {
      transform: translateX(5px);
    }

    .alert-item.critical {
      background: #ffebee;
      border-left: 4px solid #f44336;
    }

    .alert-item.warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
    }

    .alert-item.info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
    }

    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .alert-patient {
      font-weight: 600;
      color: #2c5f6f;
      font-size: 15px;
    }

    .alert-time {
      color: #999;
      font-size: 12px;
    }

    .alert-message {
      color: #555;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Patient List */
    .patient-list {
      margin-top: 20px;
    }

    .patient-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .patient-item:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .patient-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .patient-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .patient-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .patient-details h3 {
      color: #2c5f6f;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .patient-details p {
      color: #999;
      font-size: 13px;
    }

    .adherence-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .adherence-badge.high {
      background: #e8f5e9;
      color: #4caf50;
    }

    .adherence-badge.medium {
      background: #fff3e0;
      color: #ff9800;
    }

    .adherence-badge.low {
      background: #ffebee;
      color: #f44336;
    }

    .patient-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 12px;
    }

    .patient-stat {
      font-size: 13px;
      color: #666;
    }

    .patient-stat strong {
      color: #2c5f6f;
    }

    .patient-actions {
      display: flex;
      gap: 10px;
    }

    .patient-action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f5f5f5;
      color: #555;
    }

    .patient-action-btn:hover {
      background: #e0e0e0;
    }

    .patient-action-btn.primary {
      background: #5a9aae;
      color: white;
    }

    .patient-action-btn.primary:hover {
      background: #4a8a9e;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #7ba8b5;
      text-decoration: none;
      font-size: 12px;
      padding: 8px 20px;
      border-radius: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .nav-item.active {
      color: #5a9aae;
      background: #e8f4f8;
    }

    .nav-item:hover {
      background: #f0f8fa;
    }

    .nav-icon {
      font-size: 24px;
    }

    /* Chat Float Button */
    /* Chat Float Button */
    .chat-float {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-float:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .search-bar {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #2c5f6f;
      font-size: 22px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #2c5f6f;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #5a9aae;
      box-shadow: 0 0 0 3px rgba(90, 154, 174, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #5a9aae 0%, #7ba8b5 100%);
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(90, 154, 174, 0.3);
    }

    .modal-btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .modal-btn-secondary:hover {
      background: #e0e0e0;
    }

    /* AI Chat Styling */
    .chat-message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .chat-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .chat-message.ai .chat-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .chat-message.user .chat-avatar {
      background: #5a9aae;
      color: white;
    }

    .chat-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
    }

    .chat-message.ai .chat-bubble {
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .chat-message.user .chat-bubble {
      background: #5a9aae;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .typing-indicator {
      display: none;
      padding: 12px 16px;
      background: #f0f0f0;
      border-radius: 16px;
      width: fit-content;
      margin-bottom: 15px;
    }

    .typing-indicator.active {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        transform: translateY(0);
      }

      30% {
        transform: translateY(-10px);
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-section">
      <div class="logo-icon">
        <img src="search-svgrepo-com%20(1).svg" />
      </div>
      <div class="logo-text">
        <h1>ClearPharma</h1>
        <span>Pharmacist Portal</span>
      </div>
    </div>
    <div class="header-actions">
      <div class="user-info">
        <div class="user-details">
          <p>Name</p>
          <span>License #</span>
        </div>
        <div class="user-avatar">-</div>
        <button onclick="logout()" style="
              margin-left: 15px;
              padding: 8px 16px;
              background: #f44336;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            ">
          Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon">
          <span class="icon-personal-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span></span>
        </div>
        <div class="stat-value" id="statActivePatients">0</div>
        <div class="stat-label">Active Patients</div>
      </div>
      <div class="stat-card red">
        <div class="stat-icon">
          <span class="icon-bookmark-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span></span>
        </div>
        <div class="stat-value" id="statRiskAlerts">0</div>
        <div class="stat-label">Risk Alerts</div>
      </div>
      <div class="stat-card green">
        <div class="stat-icon">
          <span class="icon-browse-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span></span>
        </div>
        <div class="stat-value" id="statRefills">0</div>
        <div class="stat-label">Refills Due This Week</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-icon">
          <span class="icon-information-svgrepo-com-1"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span></span>
        </div>
        <div class="stat-value" id="statMessages">0</div>
        <div class="stat-label">Pending Messages</div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn primary" onclick="addNewPatient()">
        <span><span class="icon-pen-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span></span></span>
        Add New Patient
      </button>
      <button class="action-btn primary" onclick="generateReferralCode()">
        <span><span class="icon-key-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span></span></span>
        Generate Referral Code
      </button>
      <button class="action-btn secondary" onclick="viewReports()">
        <span><span class="icon-report-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span><span class="path38"></span><span
              class="path39"></span><span class="path40"></span><span class="path41"></span><span
              class="path42"></span><span class="path43"></span><span class="path44"></span><span
              class="path45"></span><span class="path46"></span><span class="path47"></span><span
              class="path48"></span><span class="path49"></span><span class="path50"></span></span></span>
        View Reports
      </button>
      <button class="action-btn secondary" onclick="contactServiceTeam()">
        <span><span class="icon-information-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span></span></span>
        Contact Service Team
      </button>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Risk Alerts -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <span class="icon-collect-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
                class="path3"></span><span class="path4"></span><span class="path5"></span><span
                class="path6"></span><span class="path7"></span><span class="path8"></span><span
                class="path9"></span><span class="path10"></span><span class="path11"></span><span
                class="path12"></span><span class="path13"></span><span class="path14"></span><span
                class="path15"></span><span class="path16"></span><span class="path17"></span><span
                class="path18"></span><span class="path19"></span><span class="path20"></span><span
                class="path21"></span><span class="path22"></span><span class="path23"></span><span
                class="path24"></span><span class="path25"></span><span class="path26"></span></span>
            Priority Alerts
          </h2>
          <a href="#" class="view-all">View All</a>
        </div>

        <div id="priorityAlertsContainer">
          <p style="text-align: center; color: #999; padding: 20px">
            Loading alerts...
          </p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <span class="icon-menu-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
                class="path3"></span><span class="path4"></span><span class="path5"></span><span
                class="path6"></span><span class="path7"></span><span class="path8"></span><span
                class="path9"></span><span class="path10"></span><span class="path11"></span><span
                class="path12"></span><span class="path13"></span><span class="path14"></span><span
                class="path15"></span><span class="path16"></span><span class="path17"></span><span
                class="path18"></span><span class="path19"></span><span class="path20"></span><span
                class="path21"></span><span class="path22"></span><span class="path23"></span><span
                class="path24"></span><span class="path25"></span><span class="path26"></span><span
                class="path27"></span><span class="path28"></span><span class="path29"></span></span>
            This Week
          </h2>
        </div>

        <div style="margin-top: 20px" id="weeklyStatsContainer">
          <p style="text-align: center; color: #999">Loading stats...</p>
        </div>
      </div>
    </div>

    <!-- Patient List -->
    <div class="section-card" style="margin-top: 30px">
      <div class="section-header">
        <h2 class="section-title">
          <span class="icon-personal-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span></span>
          Your Patients
        </h2>
        <a href="#" class="view-all" id="viewAllPatientsLink">View All (0)</a>
      </div>

      <div class="patient-list"></div>
    </div>
  </div>

  <!-- Chat Float Button -->
  <div class="chat-float" onclick="openChat()" title="Chat with AI Assistant">
    <span class="icon-information-svgrepo-com-1"><span class="path1"></span><span class="path2"></span><span
        class="path3"></span><span class="path4"></span><span class="path5"></span><span class="path6"></span><span
        class="path7"></span><span class="path8"></span><span class="path9"></span><span class="path10"></span><span
        class="path11"></span><span class="path12"></span><span class="path13"></span><span class="path14"></span><span
        class="path15"></span><span class="path16"></span><span class="path17"></span><span class="path18"></span><span
        class="path19"></span><span class="path20"></span><span class="path21"></span><span class="path22"></span><span
        class="path23"></span><span class="path24"></span><span class="path25"></span><span class="path26"></span><span
        class="path27"></span><span class="path28"></span><span class="path29"></span><span class="path30"></span><span
        class="path31"></span><span class="path32"></span><span class="path33"></span><span class="path34"></span><span
        class="path35"></span></span>
  </div>





  <!-- Add Patient Modal -->
  <div id="addPatientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Patient</h2>
        <button class="modal-close" onclick="closeModal('addPatientModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Patient Name</label>
          <input type="text" id="newPatientName" placeholder="Enter full name" />
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="newPatientEmail" placeholder="patient@example.com" />
        </div>
        <div class="form-group">
          <label>Phone Number (optional)</label>
          <input type="tel" id="newPatientPhone" placeholder="(123) 456-7890" />
        </div>
        <div class="form-group">
          <label>Conditions</label>
          <textarea id="newPatientConditions" placeholder="e.g., Type 2 Diabetes, Hypertension"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('addPatientModal')">
          Cancel
        </button>
        <button class="modal-btn modal-btn-primary" onclick="submitNewPatient()">
          Add Patient
        </button>
      </div>
    </div>
  </div>

  <!-- Message Patient Modal -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Send Message</h2>
        <button class="modal-close" onclick="closeModal('messageModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>To: <span id="messagePatientName"></span></label>
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea id="messageText" placeholder="Type your message here..." rows="6"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('messageModal')">
          Cancel
        </button>
        <button class="modal-btn modal-btn-primary" onclick="submitMessage()">
          Send Message
        </button>
      </div>
    </div>
  </div>

  <!-- View Patient Profile Modal -->
  <div id="viewPatientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Patient Profile</h2>
        <button class="modal-close" onclick="closeModal('viewPatientModal')">
          &times;
        </button>
      </div>
      <div class="modal-body" id="patientProfileContent">
        <p>Loading...</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('viewPatientModal')">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- View Patient History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Medication History</h2>
        <button class="modal-close" onclick="closeModal('historyModal')">
          &times;
        </button>
      </div>
      <div class="modal-body" id="historyContent">
        <p>Loading...</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('historyModal')">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Reports Modal -->
  <div id="reportsModal" class="modal">
    <div class="modal-content" style="max-width: 700px">
      <div class="modal-header">
        <h2>
          <span class="icon-report-svgrepo-com"><span class="path1"></span><span class="path2"></span><span
              class="path3"></span><span class="path4"></span><span class="path5"></span><span
              class="path6"></span><span class="path7"></span><span class="path8"></span><span
              class="path9"></span><span class="path10"></span><span class="path11"></span><span
              class="path12"></span><span class="path13"></span><span class="path14"></span><span
              class="path15"></span><span class="path16"></span><span class="path17"></span><span
              class="path18"></span><span class="path19"></span><span class="path20"></span><span
              class="path21"></span><span class="path22"></span><span class="path23"></span><span
              class="path24"></span><span class="path25"></span><span class="path26"></span><span
              class="path27"></span><span class="path28"></span><span class="path29"></span><span
              class="path30"></span><span class="path31"></span><span class="path32"></span><span
              class="path33"></span><span class="path34"></span><span class="path35"></span><span
              class="path36"></span><span class="path37"></span><span class="path38"></span><span
              class="path39"></span><span class="path40"></span><span class="path41"></span><span
              class="path42"></span><span class="path43"></span><span class="path44"></span><span
              class="path45"></span><span class="path46"></span><span class="path47"></span><span
              class="path48"></span><span class="path49"></span><span class="path50"></span></span>Analytics & Reports
        </h2>
        <button class="modal-close" onclick="closeModal('reportsModal')">
          &times;
        </button>
      </div>
      <div class="modal-body" id="reportsContent">
        <p>Loading reports...</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('reportsModal')">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- AI Chat Modal -->
  <div id="aiChatModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh">
      <div class="modal-header">
        <h2>ðŸ¤– AI Health Assistant</h2>
        <button class="modal-close" onclick="closeModal('aiChatModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div id="chatMessages" style="
          height: 400px;
          overflow-y: auto;
          border: 2px solid #e0e0e0;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          background: #f8fbfc;
        ">
          <div class="chat-message ai">
            <div class="chat-avatar">ðŸ¤–</div>
            <div class="chat-bubble">
              Hello! I'm your AI health assistant. I can help answer questions about your medications, symptoms, and
              general health. How can I assist you today?
            </div>
          </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="form-group">
          <textarea id="chatMessageInput" placeholder="Type your message..." rows="3"
            onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('aiChatModal')">
          Close
        </button>
        <button class="modal-btn modal-btn-primary" onclick="sendChatMessage()">
          Send Message
        </button>
      </div>
    </div>
  </div>

  <!-- Consultation Modal -->
  <div id="consultationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Patient Consultation</h2>
        <button class="modal-close" onclick="closeModal('consultationModal')">
          &times;
        </button>
      </div>
      <div class="modal-body" id="consultationContent">
        <p>Loading...</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('consultationModal')">
          Close
        </button>
        <button class="modal-btn modal-btn-primary" onclick="respondToConsultation()">
          Respond
        </button>
      </div>
    </div>
  </div>

  <!-- Add Medication Modal -->
  <div id="addMedicationModal" class="modal">
    <div class="modal-content" style="max-width: 600px">
      <div class="modal-header">
        <h2>ðŸ’Š Add Medication for Patient</h2>
        <button class="modal-close" onclick="closeModal('addMedicationModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Patient Name</label>
          <input type="text" id="medPatientName" readonly style="background: #f5f5f5" />
        </div>

        <div class="form-group">
          <label>Medication Name *</label>
          <input type="text" id="medName" placeholder="e.g., Metformin, Lisinopril" />
        </div>

        <div class="form-group">
          <label>Dosage *</label>
          <input type="text" id="medDosage" placeholder="e.g., 500mg, 10mg" />
        </div>

        <div class="form-group">
          <label>Frequency *</label>
          <select id="medFrequency">
            <option value="">Select frequency...</option>
            <option value="once-daily">Once Daily</option>
            <option value="twice-daily">Twice Daily (Every 12 hours)</option>
            <option value="three-times-daily">
              Three Times Daily (Every 8 hours)
            </option>
            <option value="four-times-daily">
              Four Times Daily (Every 6 hours)
            </option>
            <option value="every-other-day">Every Other Day</option>
            <option value="weekly">Once Weekly</option>
            <option value="as-needed">As Needed (PRN)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Time(s) to Take</label>
          <div id="medicationTimes">
            <input type="time" id="medTime1" style="margin-bottom: 10px" />
          </div>
          <button type="button" onclick="addTimeSlot()" style="
                font-size: 12px;
                padding: 5px 10px;
                background: #e0e0e0;
                border: none;
                border-radius: 5px;
                cursor: pointer;
              ">
            + Add Another Time
          </button>
        </div>

        <div class="form-group">
          <label>Instructions</label>
          <textarea id="medInstructions" placeholder="e.g., Take with food, Avoid alcohol" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Duration</label>
          <select id="medDuration">
            <option value="ongoing">Ongoing (No end date)</option>
            <option value="7">7 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90">90 days</option>
            <option value="custom">Custom...</option>
          </select>
        </div>

        <div class="form-group" id="customDurationGroup" style="display: none">
          <label>End Date</label>
          <input type="date" id="medEndDate" />
        </div>

        <div class="form-group">
          <label>Refills Remaining</label>
          <input type="number" id="medRefills" value="3" min="0" max="12" />
        </div>

        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="medNotes" placeholder="Additional notes for the patient..." rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('addMedicationModal')">
          Cancel
        </button>
        <button class="modal-btn modal-btn-primary" onclick="submitMedication()">
          ðŸ’Š Add Medication
        </button>
      </div>
    </div>
  </div>



  <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const GEMINI_API_KEY = "AIzaSyBOO1S1t1-myCAC3HEadXeCCDM9-DqtK1A";
    const GEMINI_MODEL = "gemini-2.0-flash-exp";

    const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: GEMINI_MODEL });

    const SYSTEM_PROMPT = `You are a helpful AI health assistant for ClearPharma, a medication management platform.

Your role is to:
- Provide helpful, accurate information about medications and health
- Be empathetic and professional
- Always remind users to consult with their healthcare provider for medical decisions
- Keep responses concise and actionable (2-3 paragraphs max)
- Never provide specific medical diagnoses or treatment plans
- Focus on medication adherence, general wellness, and education

Important: You are an AI assistant, not a replacement for healthcare professionals.`;

    let chatHistory = [];

    window.sendChatMessage = async function () {
      const messageInput = document.getElementById("chatMessageInput");
      const message = messageInput.value.trim();

      if (!message) {
        alert("Please enter a message");
        return;
      }

      addMessageToChat(message, "user");
      messageInput.value = "";

      const typingIndicator = document.getElementById("typingIndicator");
      typingIndicator.classList.add("active");

      try {
        const chatContext = SYSTEM_PROMPT + "\n\nConversation:\n" +
          chatHistory.map(msg => `${msg.role}: ${msg.content}`).join("\n") +
          `\nUser: ${message}\nAssistant:`;

        const result = await model.generateContent(chatContext);
        const response = await result.response;
        const aiMessage = response.text();

        typingIndicator.classList.remove("active");
        addMessageToChat(aiMessage, "ai");

        chatHistory.push({ role: "User", content: message });
        chatHistory.push({ role: "Assistant", content: aiMessage });

        if (chatHistory.length > 10) {
          chatHistory = chatHistory.slice(-10);
        }

      } catch (error) {
        console.error("Error calling Gemini API:", error);
        typingIndicator.classList.remove("active");
        addMessageToChat("Sorry, I'm having trouble connecting right now. Please try again in a moment.", "ai");
      }
    };

    function addMessageToChat(message, sender) {
      const chatContainer = document.getElementById("chatMessages");

      const messageDiv = document.createElement("div");
      messageDiv.className = `chat-message ${sender}`;

      const avatar = document.createElement("div");
      avatar.className = "chat-avatar";
      avatar.textContent = sender === "ai" ? "ðŸ¤–" : window.currentPatient?.name?.charAt(0) || "P";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.textContent = message;

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      chatContainer.appendChild(messageDiv);

      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    window.openChat = function () {
      openModal("aiChatModal");
    };
  </script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDwMTaAWC1crZgt-qYPA8coG_0ufUBpWBg",
      authDomain: "clearpharma-d267f.firebaseapp.com",
      projectId: "clearpharma-d267f",
      storageBucket: "clearpharma-d267f.firebasestorage.app",
      messagingSenderId: "163400096970",
      appId: "1:163400096970:web:cf0c6a3e0662823570a833",
      measurementId: "G-T0LF1E23E4",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // TEST MODE: Set this to true to view dashboard without logging in
    const TEST_MODE = false; // Set to false for production - requires login

    let currentUser = null;
    let currentPharmacist = null;

    // Check if user is logged in and is a pharmacist
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;

        try {
          // Get pharmacist data
          const pharmacistDoc = await db
            .collection("users")
            .doc(user.uid)
            .get();

          if (
            pharmacistDoc.exists &&
            pharmacistDoc.data().role === "pharmacist"
          ) {
            currentPharmacist = pharmacistDoc.data();

            // Update UI with pharmacist info
            document.querySelector(".user-details p").textContent =
              currentPharmacist.name || "Pharmacist";
            document.querySelector(
              ".user-details span"
            ).textContent = `License #${currentPharmacist.licenseNumber || "N/A"
            }`;

            // Get initials for avatar
            const initials = (currentPharmacist.name || "PH")
              .split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase();
            document.querySelector(".user-avatar").textContent = initials;

            // Load dashboard data
            loadDashboardData();
          } else {
            // Not a pharmacist, redirect to login
            alert("Access denied. Pharmacist account required.");
            if (window.location.pathname.includes("index.html") === false) {
              window.location.href = "index.html";
            }
          }
        } catch (error) {
          console.error("Error loading pharmacist data:", error);
          alert("Error loading pharmacist data. Please log in again.");
        }
      } else {
        // Not logged in
        if (TEST_MODE) {
          console.log("TEST MODE: Running dashboard without authentication");
          // Load dashboard with placeholder data
          loadDashboardData();
        } else {
          // Redirect to login page
          const shouldRedirect = confirm(
            "You need to log in to access the pharmacist dashboard. Redirect to login page?"
          );
          if (shouldRedirect) {
            window.location.href = "index.html";
          }
        }
      }
    });

    // Load dashboard statistics and data
    async function loadDashboardData() {
      try {
        // If in test mode and not logged in, show placeholder data
        if (TEST_MODE && !currentUser) {
          console.log("Loading placeholder data in test mode");
          const patientListContainer =
            document.querySelector(".patient-list");
          patientListContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p style="font-size: 18px; margin-bottom: 10px;">ðŸ§ª TEST MODE</p>
                            <p style="font-size: 14px;">Log in as a pharmacist to see real patient data</p>
                            <p style="font-size: 12px; margin-top: 10px;">The buttons work but won't save data until you're logged in</p>
                        </div>
                    `;
          return;
        }

        // Get all patients linked to this pharmacist
        const patientsSnapshot = await db
          .collection("users")
          .where("role", "==", "patient")
          .where("pharmacistId", "==", currentUser.uid)
          .get();

        const activePatients = patientsSnapshot.size;

        // Update active patients stat
        document.getElementById("statActivePatients").textContent =
          activePatients;

        // Get pending consultations (risk alerts)
        const consultationsSnapshot = await db
          .collection("consultations")
          .where("pharmacistId", "==", currentUser.uid)
          .where("status", "==", "pending")
          .get();

        document.getElementById("statRiskAlerts").textContent =
          consultationsSnapshot.size;

        // Get unread messages
        const messagesSnapshot = await db
          .collection("messages")
          .where("to", "==", currentUser.uid)
          .where("read", "==", false)
          .get();

        document.getElementById("statMessages").textContent =
          messagesSnapshot.size;

        // Refills due (placeholder for now since we don't track refills yet)
        document.getElementById("statRefills").textContent = "0";

        // Store patients for search
        if (window.storeAllPatients) {
          window.storeAllPatients(patientsSnapshot.docs);
        }

        // Load patients list
        loadPatientList(patientsSnapshot.docs);

        // Load priority alerts
        loadPriorityAlerts();

        // Load weekly stats
        loadWeeklyStats(patientsSnapshot.docs, consultationsSnapshot.size);
      } catch (error) {
        console.error("Error loading dashboard data:", error);
      }
    }

    // Load priority alerts from consultations
    async function loadPriorityAlerts() {
      try {
        const consultationsSnapshot = await db
          .collection("consultations")
          .where("pharmacistId", "==", currentUser.uid)
          .where("status", "==", "pending")
          .limit(5)
          .get();

        const alertsContainer = document.getElementById(
          "priorityAlertsContainer"
        );

        if (consultationsSnapshot.empty) {
          alertsContainer.innerHTML =
            '<p style="text-align: center; color: #999; padding: 20px;">No pending alerts</p>';
          return;
        }

        alertsContainer.innerHTML = "";

        consultationsSnapshot.forEach((doc) => {
          const consult = doc.data();
          const alertClass =
            consult.reason === "side-effects" ||
              consult.reason === "dosage-concern"
              ? "critical"
              : "info";
          const alertIcon = alertClass === "critical" ? "ðŸ”´" : "â„¹ï¸";
          const timestamp = consult.createdAt
            ? consult.createdAt.toDate
              ? consult.createdAt.toDate()
              : new Date(consult.createdAt)
            : new Date();
          const timeAgo = getTimeAgo(timestamp);

          const alertDiv = document.createElement("div");
          alertDiv.className = `alert-item ${alertClass}`;
          alertDiv.onclick = () => openConsultation(consult.patientId);
          alertDiv.innerHTML = `
                        <div class="alert-header">
                            <span class="alert-patient">${consult.patientName || "Patient"
            }</span>
                            <span class="alert-time">${timeAgo}</span>
                        </div>
                        <div class="alert-message">
                            ${alertIcon} <strong>${consult.reason
              .replace(/-/g, " ")
              .replace(/\b\w/g, (l) => l.toUpperCase())}:</strong> ${consult.details || "No details provided"
            }
                        </div>
                    `;

          alertsContainer.appendChild(alertDiv);
        });
      } catch (error) {
        console.error("Error loading alerts:", error);
        document.getElementById("priorityAlertsContainer").innerHTML =
          '<p style="text-align: center; color: #999; padding: 20px;">No pending alerts</p>';
      }
    }

    // Load weekly stats
    function loadWeeklyStats(patientDocs, consultationsCount) {
      let totalAdherence = 0;
      let patientCount = 0;

      patientDocs.forEach((doc) => {
        const patient = doc.data();
        if (patient.adherenceRate) {
          totalAdherence += patient.adherenceRate;
          patientCount++;
        }
      });

      const avgAdherence =
        patientCount > 0 ? Math.round(totalAdherence / patientCount) : 0;

      const statsHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666; font-size: 14px;">Average Adherence</span>
                        <span style="color: #4caf50; font-weight: bold;">${avgAdherence}%</span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #4caf50, #8bc34a); width: ${avgAdherence}%; height: 100%;"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666; font-size: 14px;">Pending Consultations</span>
                        <span style="color: #2196f3; font-weight: bold;">${consultationsCount}</span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #2196f3, #42a5f5); width: ${Math.min(
        consultationsCount * 10,
        100
      )}%; height: 100%;"></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666; font-size: 14px;">Active Patients</span>
                        <span style="color: #ff9800; font-weight: bold;">${patientDocs.length
        }</span>
                    </div>
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #ff9800, #ffa726); width: ${Math.min(
          patientDocs.length * 2,
          100
        )}%; height: 100%;"></div>
                    </div>
                </div>

                <div style="background: #e8f4f8; padding: 15px; border-radius: 12px; margin-top: 25px;">
                    <div style="font-size: 13px; color: #5a9aae; margin-bottom: 8px;">ðŸ’¡ Quick Tip</div>
                    <div style="font-size: 14px; color: #2c5f6f; line-height: 1.5;">
                        ${avgAdherence >= 80
          ? "Great job! Your patients are maintaining excellent adherence."
          : "Focus on improving patient adherence for better health outcomes."
        }
                    </div>
                </div>
            `;

      document.getElementById("weeklyStatsContainer").innerHTML = statsHTML;
    }

    // Helper function to get time ago
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);

      if (seconds < 60) return "Just now";
      if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
      return `${Math.floor(seconds / 86400)} days ago`;
    }

    // Load patient list
    function loadPatientList(patientDocs) {
      const patientListContainer = document.querySelector(".patient-list");

      // Update View All link
      const viewAllLink = document.getElementById("viewAllPatientsLink");
      if (viewAllLink) {
        viewAllLink.textContent = `View All (${patientDocs.length})`;
      }

      if (patientDocs.length === 0) {
        patientListContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 18px; margin-bottom: 10px;">ðŸ“‹ No patients yet</p>
                        <p style="font-size: 14px;">Generate a referral code to start adding patients!</p>
                    </div>
                `;
        return;
      }

      patientListContainer.innerHTML = "";

      patientDocs.forEach((doc) => {
        const patient = doc.data();
        const patientId = doc.id;

        const initials = (patient.name || "PT")
          .split(" ")
          .map((n) => n[0])
          .join("")
          .toUpperCase();
        const adherence =
          patient.adherenceRate || Math.floor(Math.random() * 40) + 60; // Random for demo
        const adherenceClass =
          adherence >= 80 ? "high" : adherence >= 60 ? "medium" : "low";

        const patientCard = document.createElement("div");
        patientCard.className = "patient-item";
        patientCard.onclick = () => viewPatient(patientId);

        patientCard.innerHTML = `
  <div class="patient-header">
    <div class="patient-info">
      <div class="patient-avatar">${initials}</div>
      <div class="patient-details">
        <h3>${patient.name || "Patient"}</h3>
        <p>ID: ${patientId.substring(0, 8)} â€¢ ${patient.conditions || "No conditions listed"
          }</p>
      </div>
    </div>
    <div class="adherence-badge ${adherenceClass}">${adherence}% Adherence</div>
  </div>
  <div class="patient-stats">
    <div class="patient-stat"><strong>${patient.medicationCount || 0
          }</strong> Medications</div>
    <div class="patient-stat"><strong>${patient.missedDoses || 0
          }</strong> Missed Doses</div>
    <div class="patient-stat">Last Check: <strong>${getTimeSince(
            patient.lastCheck
          )}</strong></div>
  </div>
  <div class="patient-actions">
    <button class="patient-action-btn primary" onclick="event.stopPropagation(); viewPatientMedications('${patientId}', '${patient.name || "Patient"
          }')">
      ðŸ’Š Medications
    </button>
    <button class="patient-action-btn primary" onclick="event.stopPropagation(); addMedicationForPatient('${patientId}', '${patient.name || "Patient"
          }')">
      + Add Med
    </button>
    <button class="patient-action-btn" onclick="event.stopPropagation(); viewProfile('${patientId}')">
      View Profile
    </button>
    <button class="patient-action-btn" onclick="event.stopPropagation(); sendMessage('${patientId}')">
      Message
    </button>
    <button class="patient-action-btn" onclick="event.stopPropagation(); viewHistory('${patientId}')">
      History
    </button>
  </div>`;

        patientListContainer.appendChild(patientCard);
      });
    }

    // Helper function to get time since last check
    function getTimeSince(timestamp) {
      if (!timestamp) return "Never";

      const now = new Date();
      const then = timestamp.toDate
        ? timestamp.toDate()
        : new Date(timestamp);
      const diffMs = now - then;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return "Today";
      if (diffDays === 1) return "1 day ago";
      return `${diffDays} days ago`;
    }

    // Search functionality
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
        let allPatients = [];

        // Store all patients when loaded
        window.storeAllPatients = (patients) => {
          allPatients = patients;
        };

        searchInput.addEventListener("input", function (e) {
          const searchTerm = e.target.value.toLowerCase().trim();

          if (searchTerm === "") {
            loadPatientList(allPatients);
            return;
          }

          const filteredPatients = allPatients.filter((doc) => {
            const patient = doc.data();
            const name = (patient.name || "").toLowerCase();
            const email = (patient.email || "").toLowerCase();
            const id = doc.id.toLowerCase();
            return (
              name.includes(searchTerm) ||
              email.includes(searchTerm) ||
              id.includes(searchTerm)
            );
          });

          loadPatientList(filteredPatients);
        });
      }
    });

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add("active");
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove("active");
    }

    // Add New Patient - open modal
    function addNewPatient() {
      openModal("addPatientModal");
    }

    // Submit new patient from modal
    async function submitNewPatient() {
      const name = document.getElementById("newPatientName").value.trim();
      const email = document.getElementById("newPatientEmail").value.trim();
      const phone = document.getElementById("newPatientPhone").value.trim();
      const conditions = document
        .getElementById("newPatientConditions")
        .value.trim();

      if (!name || !email) {
        alert("Please enter patient name and email");
        return;
      }

      try {
        const newPatient = {
          name: name,
          email: email,
          phone: phone || "",
          role: "patient",
          pharmacistId: currentUser.uid,
          conditions: conditions || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          adherenceRate: 100,
          medicationCount: 0,
          missedDoses: 0,
        };

        const docRef = await db.collection("users").add(newPatient);

        alert(
          `âœ… Patient "${name}" added successfully!\nPatient ID: ${docRef.id.substring(
            0,
            8
          )}`
        );

        // Clear form
        document.getElementById("newPatientName").value = "";
        document.getElementById("newPatientEmail").value = "";
        document.getElementById("newPatientPhone").value = "";
        document.getElementById("newPatientConditions").value = "";

        closeModal("addPatientModal");
        loadDashboardData();
      } catch (error) {
        console.error("Error adding patient:", error);
        alert("Error adding patient. Please try again.");
      }
    }

    // Generate Referral Code
    async function generateReferralCode() {
      try {
        Swal.fire({
          title: "Generating Code...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const code =
          "RX-" + Math.random().toString(36).substr(2, 9).toUpperCase();

        await db.collection("referralCodes").add({
          code: code,
          pharmacistId: currentUser.uid,
          pharmacistName: currentPharmacist.name,
          used: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
        });

        Swal.fire({
          title: "âœ… Referral Code Generated!",
          html: `<div style="text-align: center;">
        <p style="color: #666; margin-bottom: 20px;">Share this code with your patient.</p>
        <div style="background: linear-gradient(135deg, #e8f4f8 0%, #d0e8ef 100%); padding: 25px; border-radius: 15px; margin: 25px 0; border: 2px dashed #5a9aae;">
          <div style="font-size: 36px; font-weight: bold; color: #2c5f6f; letter-spacing: 3px; font-family: monospace;">${code}</div>
        </div>
        <p style="color: #666; font-size: 14px;"><strong>Valid for:</strong> 30 days</p>
      </div>`,
          icon: "success",
          confirmButtonText: "ðŸ“‹ Copy Code",
          confirmButtonColor: "#5a9aae",
          showCancelButton: true,
          cancelButtonText: "Close",
          width: "550px",
        }).then((result) => {
          if (result.isConfirmed) {
            navigator.clipboard.writeText(code).then(() => {
              Swal.fire({
                title: "Copied! ðŸ“‹",
                text: `Code ${code} copied to clipboard!`,
                icon: "success",
                timer: 2000,
                showConfirmButton: false,
              });
            });
          }
        });
      } catch (error) {
        Swal.fire({
          title: "Error!",
          text: "Failed to generate code.",
          icon: "error",
          confirmButtonColor: "#5a9aae",
        });
      }
    }

    // View Reports
    async function viewReports() {
      try {
        const patientsSnapshot = await db
          .collection("users")
          .where("role", "==", "patient")
          .where("pharmacistId", "==", currentUser.uid)
          .get();

        const totalPatients = patientsSnapshot.size;
        let totalAdherence = 0;
        let highRiskCount = 0;
        let excellentCount = 0;

        patientsSnapshot.forEach((doc) => {
          const patient = doc.data();
          const adherence = patient.adherenceRate || 0;
          totalAdherence += adherence;

          if (adherence < 70) highRiskCount++;
          if (adherence >= 90) excellentCount++;
        });

        const avgAdherence =
          totalPatients > 0 ? Math.round(totalAdherence / totalPatients) : 0;

        const reportsHTML = `
                    <div style="line-height: 2;">
                        <h3 style="margin-bottom: 20px; color: #2c5f6f;">Patient Overview</h3>
                        
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2196f3;">${totalPatients}</div>
                            <div style="color: #666;">Total Active Patients</div>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #4caf50;">${avgAdherence}%</div>
                            <div style="color: #666;">Average Adherence Rate</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: #fff3e0; padding: 15px; border-radius: 12px;">
                                <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${highRiskCount}</div>
                                <div style="color: #666; font-size: 14px;">High Risk Patients</div>
                                <div style="color: #999; font-size: 12px;">(&lt;70% adherence)</div>
                            </div>
                            
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 12px;">
                                <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${excellentCount}</div>
                                <div style="color: #666; font-size: 14px;">Excellent Adherence</div>
                                <div style="color: #999; font-size: 12px;">(&gt;90% adherence)</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8fbfc; border-radius: 12px;">
                            <div style="font-size: 14px; color: #2c5f6f; font-weight: 600; margin-bottom: 10px;">ðŸ’¡ Insights</div>
                            <ul style="color: #666; font-size: 14px; padding-left: 20px;">
                                <li>Focus on the ${highRiskCount} high-risk patients for intervention</li>
                                <li>${excellentCount} patients are maintaining excellent adherence</li>
                                <li>Overall patient health outcomes are ${avgAdherence >= 80
            ? "strong"
            : "showing room for improvement"
          }</li>
                            </ul>
                        </div>
                    </div>
                `;

        document.getElementById("reportsContent").innerHTML = reportsHTML;
        openModal("reportsModal");
      } catch (error) {
        console.error("Error loading reports:", error);
        alert("Error loading reports. Please try again.");
      }
    }

    // Contact Service Team
    function contactServiceTeam() {
      alert(
        "ðŸ¥ Service Team Contact\n\nEmail: support@clearpharma.com\nPhone: 1-800-PHARMA\n\n(Live chat integration coming soon!)"
      );
    }

    // View Patient Details
    async function viewPatient(patientId) {
      try {
        const patientDoc = await db.collection("users").doc(patientId).get();

        if (patientDoc.exists) {
          const patient = patientDoc.data();

          // Get recent symptoms
          const symptomsSnapshot = await db
            .collection("symptoms")
            .where("patientId", "==", patientId)
            .limit(5)
            .get();

          let symptomsHTML = "";
          if (!symptomsSnapshot.empty) {
            symptomsHTML =
              '<div style="margin-top: 20px;"><strong>Recent Symptoms:</strong><div style="margin-top: 10px;">';
            symptomsSnapshot.forEach((doc) => {
              const symptom = doc.data();
              const severityColor =
                symptom.severity === "severe"
                  ? "#f44336"
                  : symptom.severity === "moderate"
                    ? "#ff9800"
                    : "#4caf50";
              symptomsHTML += `
                                <div style="background: #f8fbfc; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${severityColor};">
                                    <div style="font-weight: 600; color: #2c5f6f;">${symptom.type
                }</div>
                                    <div style="font-size: 13px; color: #666;">${symptom.description || "No description"
                }</div>
                                    <div style="font-size: 12px; color: #999; margin-top: 5px;">Severity: ${symptom.severity
                }</div>
                                </div>
                            `;
            });
            symptomsHTML += "</div></div>";
          }

          const profileHTML = `
                        <div style="line-height: 1.8;">
                            <p><strong>Name:</strong> ${patient.name}</p>
                            <p><strong>Email:</strong> ${patient.email}</p>
                            <p><strong>Phone:</strong> ${patient.phone || "Not provided"
            }</p>
                            <p><strong>Conditions:</strong> ${patient.conditions || "None listed"
            }</p>
                            <p><strong>Adherence Rate:</strong> ${patient.adherenceRate || 0
            }%</p>
                            <p><strong>Medications:</strong> ${patient.medicationCount || 0
            }</p>
                            <p><strong>Missed Doses:</strong> ${patient.missedDoses || 0
            }</p>
                            ${symptomsHTML}
                        </div>
                    `;

          document.getElementById("patientProfileContent").innerHTML =
            profileHTML;
          openModal("viewPatientModal");
        }
      } catch (error) {
        console.error("Error viewing patient:", error);
        alert("Error loading patient data.");
      }
    }

    // View Profile
    function viewProfile(patientId) {
      viewPatient(patientId);
    }

    // Send Message - open modal
    let currentMessagePatientId = null;

    async function sendMessage(patientId) {
      try {
        currentMessagePatientId = patientId;
        const patientDoc = await db.collection("users").doc(patientId).get();
        const patient = patientDoc.data();

        document.getElementById("messagePatientName").textContent =
          patient.name;
        document.getElementById("messageText").value = "";
        openModal("messageModal");
      } catch (error) {
        console.error("Error loading patient:", error);
        alert("Error loading patient data.");
      }
    }

    // Submit message from modal
    async function submitMessage() {
      const message = document.getElementById("messageText").value.trim();

      if (!message) {
        alert("Please enter a message");
        return;
      }

      try {
        const patientDoc = await db
          .collection("users")
          .doc(currentMessagePatientId)
          .get();
        const patient = patientDoc.data();

        await db.collection("messages").add({
          from: currentUser.uid,
          fromName: currentPharmacist.name,
          to: currentMessagePatientId,
          toName: patient.name,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false,
        });

        alert(`âœ… Message sent to ${patient.name}!`);
        closeModal("messageModal");
      } catch (error) {
        console.error("Error sending message:", error);
        alert("Error sending message. Please try again.");
      }
    }

    // View History
    async function viewHistory(patientId) {
      try {
        const patientDoc = await db.collection("users").doc(patientId).get();
        const patient = patientDoc.data();

        // Get medication history
        const medsSnapshot = await db
          .collection("medications")
          .where("patientId", "==", patientId)
          .orderBy("scheduledTime", "desc")
          .limit(20)
          .get();

        let historyHTML = `<h3 style="margin-bottom: 15px;">${patient.name}'s Medication History</h3>`;

        if (medsSnapshot.empty) {
          historyHTML +=
            '<p style="text-align: center; color: #999;">No medication history found</p>';
        } else {
          historyHTML += '<div style="max-height: 400px; overflow-y: auto;">';
          medsSnapshot.forEach((doc) => {
            const med = doc.data();
            const statusColor =
              med.status === "taken"
                ? "#4caf50"
                : med.status === "missed"
                  ? "#f44336"
                  : "#2196f3";
            const time = med.scheduledTime
              ? med.scheduledTime.toDate
                ? med.scheduledTime.toDate()
                : new Date(med.scheduledTime)
              : new Date();
            historyHTML += `
                            <div style="padding: 12px; background: #f8fbfc; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColor};">
                                <div style="font-weight: 600; color: #2c5f6f;">${med.name || "Medication"
              }</div>
                                <div style="font-size: 13px; color: #666;">${med.dosage || "Standard dose"
              }</div>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    ${time.toLocaleDateString()} ${time.toLocaleTimeString()} - ${med.status || "Scheduled"
              }
                                </div>
                            </div>
                        `;
          });
          historyHTML += "</div>";
        }

        document.getElementById("historyContent").innerHTML = historyHTML;
        openModal("historyModal");
      } catch (error) {
        console.error("Error viewing history:", error);
        alert("Error loading medication history.");
      }
    }

    // Open Consultation
    async function openConsultation(patientId) {
      try {
        const patientDoc = await db.collection("users").doc(patientId).get();
        const patient = patientDoc.data();

        // Get consultation requests
        const consultSnapshot = await db
          .collection("consultations")
          .where("patientId", "==", patientId)
          .where("status", "==", "pending")
          .orderBy("createdAt", "desc")
          .limit(1)
          .get();

        let consultHTML = `<h3 style="margin-bottom: 15px;">Consultation Request - ${patient.name}</h3>`;

        if (consultSnapshot.empty) {
          consultHTML +=
            '<p style="text-align: center; color: #999;">No pending consultation requests</p>';
        } else {
          const consult = consultSnapshot.docs[0].data();
          const timestamp = consult.createdAt
            ? consult.createdAt.toDate
              ? consult.createdAt.toDate()
              : new Date(consult.createdAt)
            : new Date();
          consultHTML += `
                        <div style="background: #f8fbfc; padding: 20px; border-radius: 12px;">
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: 600; color: #2c5f6f; margin-bottom: 5px;">Reason:</div>
                                <div style="color: #666;">${consult.reason || "Not specified"
            }</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: 600; color: #2c5f6f; margin-bottom: 5px;">Details:</div>
                                <div style="color: #666;">${consult.details || "No additional details"
            }</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #2c5f6f; margin-bottom: 5px;">Submitted:</div>
                                <div style="color: #999; font-size: 13px;">${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
        }

        document.getElementById("consultationContent").innerHTML =
          consultHTML;
        openModal("consultationModal");
      } catch (error) {
        console.error("Error opening consultation:", error);
        alert("Error loading consultation.");
      }
    }

    function respondToConsultation() {
      alert(
        "Opening consultation response interface...\n\nYou can:\nâ€¢ Send a message to the patient\nâ€¢ Schedule a video call\nâ€¢ Update medication plan\nâ€¢ Escalate to service team"
      );
      closeModal("consultationModal");
    }

    // Open Service Team Chat
    function openServiceTeamChat() {
      loadServiceTeamMessages();
      openModal("serviceTeamModal");
    }

    // Load service team messages
    async function loadServiceTeamMessages() {
      try {
        const messagesSnapshot = await db
          .collection("serviceTeamMessages")
          .where("userId", "==", currentUser.uid)
          .orderBy("timestamp", "asc")
          .limit(50)
          .get();

        const chatContainer = document.getElementById("chatMessages");

        if (messagesSnapshot.empty) {
          chatContainer.innerHTML =
            '<p style="text-align: center; color: #999;">No messages yet. Start a conversation!</p>';
        } else {
          chatContainer.innerHTML = "";
          messagesSnapshot.forEach((doc) => {
            const msg = doc.data();
            const isUser = msg.senderId === currentUser.uid;
            const timestamp = msg.timestamp
              ? msg.timestamp.toDate
                ? msg.timestamp.toDate()
                : new Date(msg.timestamp)
              : new Date();

            const messageDiv = document.createElement("div");
            messageDiv.style.cssText = `
                            margin-bottom: 12px;
                            text-align: ${isUser ? "right" : "left"};
                        `;

            messageDiv.innerHTML = `
                            <div style="
                                display: inline-block;
                                max-width: 70%;
                                padding: 10px 15px;
                                background: ${isUser ? "#5a9aae" : "#f0f0f0"};
                                color: ${isUser ? "white" : "#333"};
                                border-radius: 12px;
                                text-align: left;
                            ">
                                <div style="font-size: 14px;">${msg.message
              }</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">
                                    ${timestamp.toLocaleTimeString()}
                                </div>
                            </div>
                        `;

            chatContainer.appendChild(messageDiv);
          });

          // Scroll to bottom
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      } catch (error) {
        console.error("Error loading messages:", error);
      }
    }

    // Send message to service team
    async function sendServiceTeamMessage() {
      const messageInput = document.getElementById("chatMessageInput");
      const message = messageInput.value.trim();

      if (!message) {
        alert("Please enter a message");
        return;
      }

      try {
        await db.collection("serviceTeamMessages").add({
          userId: currentUser.uid,
          userName: currentPharmacist.name,
          userRole: "pharmacist",
          senderId: currentUser.uid,
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false,
        });

        messageInput.value = "";
        loadServiceTeamMessages();
      } catch (error) {
        console.error("Error sending message:", error);
        alert("Error sending message. Please try again.");
      }
    }

    // Contact Service Team
    function contactServiceTeam() {
      openServiceTeamChat();
    }

    // Simulate real-time notifications
    setTimeout(() => {
      console.log("New risk alert received for Patient #12349");
      // In real implementation, this would show a toast notification
    }, 5000);

    // Logout function with SweetAlert2
    async function logout() {
      const result = await Swal.fire({
        title: "Logout?",
        text: "Are you sure you want to log out?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#5a9aae",
        cancelButtonColor: "#999",
        confirmButtonText: "Yes, logout",
        cancelButtonText: "Cancel",
      });

      if (result.isConfirmed) {
        try {
          await auth.signOut();

          Swal.fire({
            title: "Logged Out!",
            text: "See you next time!",
            icon: "success",
            timer: 1500,
            showConfirmButton: false,
          });

          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        } catch (error) {
          console.error("Error logging out:", error);
          Swal.fire({
            title: "Error!",
            text: "Could not log out. Please try again.",
            icon: "error",
            confirmButtonColor: "#5a9aae",
          });
        }
      }
    }

    // Global variable to track current patient for medication
    let currentMedicationPatientId = null;
    let timeSlotCount = 1;

    // Open Add Medication Modal
    async function addMedicationForPatient(patientId, patientName) {
      try {
        currentMedicationPatientId = patientId;

        // Set patient name
        document.getElementById("medPatientName").value = patientName;

        // Reset form
        document.getElementById("medName").value = "";
        document.getElementById("medDosage").value = "";
        document.getElementById("medFrequency").value = "";
        document.getElementById("medTime1").value = "09:00";
        document.getElementById("medInstructions").value = "";
        document.getElementById("medDuration").value = "ongoing";
        document.getElementById("medRefills").value = "3";
        document.getElementById("medNotes").value = "";
        document.getElementById("customDurationGroup").style.display = "none";

        // Reset time slots
        timeSlotCount = 1;
        document.getElementById("medicationTimes").innerHTML =
          '<input type="time" id="medTime1" style="margin-bottom: 10px;" value="09:00">';

        openModal("addMedicationModal");
      } catch (error) {
        console.error("Error opening medication modal:", error);
        Swal.fire({
          title: "Error",
          text: "Could not open medication form",
          icon: "error",
          confirmButtonColor: "#5a9aae",
        });
      }
    }

    // Add another time slot
    function addTimeSlot() {
      timeSlotCount++;
      const timesContainer = document.getElementById("medicationTimes");
      const newTimeInput = document.createElement("input");
      newTimeInput.type = "time";
      newTimeInput.id = `medTime${timeSlotCount}`;
      newTimeInput.style.marginBottom = "10px";
      newTimeInput.value = "09:00";
      timesContainer.appendChild(newTimeInput);
    }

    // Handle duration dropdown
    document.addEventListener("DOMContentLoaded", () => {
      const durationSelect = document.getElementById("medDuration");
      if (durationSelect) {
        durationSelect.addEventListener("change", function () {
          const customGroup = document.getElementById("customDurationGroup");
          if (this.value === "custom") {
            customGroup.style.display = "block";
          } else {
            customGroup.style.display = "none";
          }
        });
      }
    });

    // Submit Medication
    async function submitMedication() {
      console.log("ðŸ”µ Starting medication submission...");

      const name = document.getElementById("medName").value.trim();
      const dosage = document.getElementById("medDosage").value.trim();
      const frequency = document.getElementById("medFrequency").value;
      const instructions = document
        .getElementById("medInstructions")
        .value.trim();
      const duration = document.getElementById("medDuration").value;
      const refills = parseInt(document.getElementById("medRefills").value);
      const notes = document.getElementById("medNotes").value.trim();

      console.log("ðŸ“‹ Form data:", { name, dosage, frequency, duration });

      // Validation
      if (!name || !dosage || !frequency) {
        Swal.fire({
          title: "Missing Information",
          text: "Please fill in medication name, dosage, and frequency",
          icon: "warning",
          confirmButtonColor: "#5a9aae",
        });
        return;
      }

      // Get all time slots
      const times = [];
      for (let i = 1; i <= timeSlotCount; i++) {
        const timeInput = document.getElementById(`medTime${i}`);
        if (timeInput && timeInput.value) {
          times.push(timeInput.value);
        }
      }

      console.log("â° Times collected:", times);

      if (times.length === 0) {
        Swal.fire({
          title: "Missing Time",
          text: "Please specify at least one time to take the medication",
          icon: "warning",
          confirmButtonColor: "#5a9aae",
        });
        return;
      }

      // Calculate end date
      let endDate = null;
      if (duration === "custom") {
        const customEndDate = document.getElementById("medEndDate").value;
        if (customEndDate) {
          endDate = new Date(customEndDate);
          console.log("ðŸ“… Custom end date:", endDate);
        }
      } else if (duration !== "ongoing") {
        const days = parseInt(duration);
        endDate = new Date();
        endDate.setDate(endDate.getDate() + days);
        console.log("ðŸ“… Calculated end date:", endDate, `(${days} days)`);
      }

      // Show loading
      Swal.fire({
        title: "Adding Medication...",
        html: "Saving to database...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      try {
        console.log(
          "ðŸ” Getting patient info for:",
          currentMedicationPatientId
        );

        // Get patient info
        const patientDoc = await db
          .collection("users")
          .doc(currentMedicationPatientId)
          .get();

        if (!patientDoc.exists) {
          throw new Error("Patient not found");
        }

        const patient = patientDoc.data();
        console.log("ðŸ‘¤ Patient found:", patient.name);

        // Create medication document
        const medicationData = {
          patientId: currentMedicationPatientId,
          patientName: patient.name,
          pharmacistId: currentUser.uid,
          pharmacistName: currentPharmacist.name,

          name: name,
          dosage: dosage,
          frequency: frequency,
          times: times,
          instructions: instructions,
          notes: notes,

          startDate: firebase.firestore.FieldValue.serverTimestamp(),
          endDate: endDate,
          duration: duration,

          refillsRemaining: refills,
          active: true,

          adherenceTracking: {
            totalDoses: 0,
            takenDoses: 0,
            missedDoses: 0,
            adherenceRate: 100,
          },

          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        console.log("ðŸ’¾ Saving medication data...");

        // Add to medications collection
        const medRef = await db.collection("medications").add(medicationData);
        console.log("âœ… Medication saved with ID:", medRef.id);

        // Create scheduled doses for the next 7 days
        console.log("ðŸ“… Creating scheduled doses...");
        try {
          await createScheduledDoses(medRef.id, medicationData);
          console.log("âœ… Scheduled doses created");
        } catch (doseError) {
          console.warn(
            "âš ï¸ Error creating scheduled doses (non-critical):",
            doseError
          );
          // Continue anyway - this is not critical
        }

        // Update patient's medication count
        console.log("ðŸ”¢ Updating patient medication count...");
        try {
          const patientMedsSnapshot = await db
            .collection("medications")
            .where("patientId", "==", currentMedicationPatientId)
            .where("active", "==", true)
            .get();

          await db
            .collection("users")
            .doc(currentMedicationPatientId)
            .update({
              medicationCount: patientMedsSnapshot.size,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          console.log(
            "âœ… Patient medication count updated:",
            patientMedsSnapshot.size
          );
        } catch (countError) {
          console.warn(
            "âš ï¸ Error updating medication count (non-critical):",
            countError
          );
          // Continue anyway
        }

        // Send notification to patient
        console.log("ðŸ“§ Sending notification to patient...");
        try {
          await db.collection("messages").add({
            from: currentUser.uid,
            fromName: currentPharmacist.name,
            to: currentMedicationPatientId,
            toName: patient.name,
            type: "medication_added",
            message: `New medication prescribed: ${name} (${dosage}) - ${frequency}. Please check your medication list for details.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false,
          });
          console.log("âœ… Notification sent");
        } catch (messageError) {
          console.warn(
            "âš ï¸ Error sending notification (non-critical):",
            messageError
          );
          // Continue anyway
        }

        console.log("ðŸŽ‰ All done! Showing success message...");

        // Success!
        Swal.fire({
          title: "Medication Added! ðŸ’Š",
          html: `
        <div style="text-align: center;">
          <p style="color: #666; margin: 15px 0;">
            <strong style="color: #2c5f6f;">${name}</strong> has been added to 
            <strong style="color: #2c5f6f;">${patient.name
            }'s</strong> medication list.
          </p>
          <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 20px 0;">
            <p style="color: #2e7d32; font-size: 14px; margin: 5px 0;">
              <strong>Dosage:</strong> ${dosage}
            </p>
            <p style="color: #2e7d32; font-size: 14px; margin: 5px 0;">
              <strong>Frequency:</strong> ${frequency.replace(/-/g, " ")}
            </p>
            <p style="color: #2e7d32; font-size: 14px; margin: 5px 0;">
              <strong>Times:</strong> ${times.join(", ")}
            </p>
          </div>
          <p style="color: #999; font-size: 13px;">
            âœ‰ï¸ Patient has been notified
          </p>
        </div>
      `,
          icon: "success",
          confirmButtonColor: "#5a9aae",
          confirmButtonText: "Great!",
        });

        closeModal("addMedicationModal");

        // Refresh dashboard
        console.log("ðŸ”„ Refreshing dashboard...");
        try {
          loadDashboardData();
        } catch (refreshError) {
          console.warn("âš ï¸ Error refreshing dashboard:", refreshError);
        }
      } catch (error) {
        console.error("âŒ ERROR in submitMedication:", error);
        console.error("Error details:", {
          code: error.code,
          message: error.message,
          stack: error.stack,
        });

        Swal.fire({
          title: "Error",
          html: `
        <p>Failed to add medication.</p>
        <p style="color: #999; font-size: 12px; margin-top: 10px;">
          Error: ${error.message}
        </p>
        <p style="color: #999; font-size: 12px;">
          Check the console for more details (F12)
        </p>
      `,
          icon: "error",
          confirmButtonColor: "#5a9aae",
        });
      }
    }

    // Create scheduled doses for medication
    async function createScheduledDoses(medicationId, medicationData) {
      console.log(
        "ðŸ“… Creating scheduled doses for medication:",
        medicationId
      );

      try {
        const batch = db.batch();
        const now = new Date();
        let doseCount = 0;

        // Create doses for next 7 days
        for (let day = 0; day < 7; day++) {
          const doseDate = new Date(now);
          doseDate.setDate(doseDate.getDate() + day);

          medicationData.times.forEach((time) => {
            const [hours, minutes] = time.split(":");
            const scheduledTime = new Date(doseDate);
            scheduledTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            // Don't create doses in the past
            if (scheduledTime > now) {
              const doseRef = db.collection("scheduledDoses").doc();
              batch.set(doseRef, {
                medicationId: medicationId,
                patientId: medicationData.patientId,
                pharmacistId: medicationData.pharmacistId,
                medicationName: medicationData.name,
                dosage: medicationData.dosage,
                scheduledTime: scheduledTime,
                status: "pending", // pending, taken, missed, skipped
                takenAt: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
              doseCount++;
            }
          });
        }

        if (doseCount > 0) {
          await batch.commit();
          console.log(`âœ… Created ${doseCount} scheduled doses`);
        } else {
          console.log("âš ï¸ No future doses to schedule");
        }
      } catch (error) {
        console.error("âŒ Error creating scheduled doses:", error);
        // Don't throw - this is not critical
      }
    }

    // View Patient Medications
    async function viewPatientMedications(patientId, patientName) {
      try {
        Swal.fire({
          title: "Loading...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const medsSnapshot = await db
          .collection("medications")
          .where("patientId", "==", patientId)
          .where("active", "==", true)
          .get();

        let medsHTML = `<h3 style="margin-bottom: 15px;">${patientName}'s Medications</h3>`;

        if (medsSnapshot.empty) {
          medsHTML +=
            '<p style="text-align: center; color: #999;">No medications prescribed yet</p>';
        } else {
          medsHTML += '<div style="max-height: 400px; overflow-y: auto;">';
          medsSnapshot.forEach((doc) => {
            const med = doc.data();
            const adherence = med.adherenceTracking?.adherenceRate || 100;
            const adherenceColor =
              adherence >= 80
                ? "#4caf50"
                : adherence >= 60
                  ? "#ff9800"
                  : "#f44336";

            medsHTML += `
          <div style="background: #f8fbfc; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #5a9aae;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div>
                <div style="font-weight: 600; color: #2c5f6f; font-size: 16px;">${med.name
              }</div>
                <div style="color: #666; font-size: 14px;">${med.dosage
              } - ${med.frequency.replace(/-/g, " ")}</div>
              </div>
              <div style="background: ${adherenceColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                ${adherence}%
              </div>
            </div>
            <div style="font-size: 13px; color: #666; margin: 8px 0;">
              <strong>Times:</strong> ${med.times.join(", ")}
            </div>
            ${med.instructions
                ? `<div style="font-size: 13px; color: #666; margin: 8px 0;"><strong>Instructions:</strong> ${med.instructions}</div>`
                : ""
              }
            <div style="font-size: 12px; color: #999; margin-top: 10px;">
              Refills: ${med.refillsRemaining} | 
              Doses: ${med.adherenceTracking?.takenDoses || 0}/${med.adherenceTracking?.totalDoses || 0
              }
            </div>
            <div style="margin-top: 10px; display: flex; gap: 8px;">
              <button onclick="editMedication('${doc.id
              }')" style="padding: 6px 12px; background: #5a9aae; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">Edit</button>
              <button onclick="discontinueMedication('${doc.id}', '${med.name
              }')" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">Discontinue</button>
            </div>
          </div>
        `;
          });
          medsHTML += "</div>";
        }

        Swal.fire({
          title: "ðŸ’Š Medications",
          html: medsHTML,
          width: "700px",
          confirmButtonColor: "#5a9aae",
          confirmButtonText: "Close",
          showCancelButton: true,
          cancelButtonText: "+ Add New Medication",
          cancelButtonColor: "#4caf50",
        }).then((result) => {
          if (result.dismiss === Swal.DismissReason.cancel) {
            addMedicationForPatient(patientId, patientName);
          }
        });
      } catch (error) {
        console.error("Error viewing medications:", error);
        Swal.fire({
          title: "Error",
          text: "Could not load medications",
          icon: "error",
          confirmButtonColor: "#5a9aae",
        });
      }
    }

    // Discontinue Medication
    // IMPROVED DISCONTINUE MEDICATION FUNCTION
    // Replace the discontinueMedication function in pharmacist-dashboard.html

    async function discontinueMedication(medicationId, medicationName) {
      const result = await Swal.fire({
        title: "âš ï¸ Discontinue Medication?",
        html: `
      <div style="text-align: left; padding: 10px;">
        <p style="color: #666; margin-bottom: 15px;">
          Are you sure you want to discontinue <strong style="color: #2c5f6f;">${medicationName}</strong>?
        </p>
        <div style="background: #fff3e0; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800; margin: 15px 0;">
          <p style="color: #e65100; font-size: 14px; margin: 0 0 10px 0;">
            <strong>âš ï¸ This will:</strong>
          </p>
          <ul style="color: #666; font-size: 14px; margin: 5px 0 0 20px; line-height: 1.8;">
            <li>Mark the medication as inactive</li>
            <li>Remove it from patient's daily medication list</li>
            <li>Send a notification to the patient</li>
            <li>Keep records for history (not permanently deleted)</li>
          </ul>
        </div>
        <div style="margin-top: 15px;">
          <label style="display: block; color: #2c5f6f; font-weight: 600; margin-bottom: 8px;">
            Reason for discontinuation (optional):
          </label>
          <textarea 
            id="discontinueReason" 
            placeholder="e.g., Treatment completed, Side effects, Switched to alternative..." 
            style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 80px;"
          ></textarea>
        </div>
      </div>
    `,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#f44336",
        cancelButtonColor: "#999",
        confirmButtonText: "Yes, Discontinue",
        cancelButtonText: "Cancel",
        width: "550px",
        preConfirm: () => {
          return {
            reason: document.getElementById("discontinueReason").value.trim(),
          };
        },
      });

      if (result.isConfirmed) {
        try {
          // Show loading
          Swal.fire({
            title: "Discontinuing Medication...",
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          // Get medication details for notification
          const medDoc = await db
            .collection("medications")
            .doc(medicationId)
            .get();
          const medication = medDoc.data();

          // Discontinue the medication
          await db
            .collection("medications")
            .doc(medicationId)
            .update({
              active: false,
              discontinuedAt: firebase.firestore.FieldValue.serverTimestamp(),
              discontinuedBy: currentUser.uid,
              discontinuedByName: currentPharmacist.name,
              discontinueReason: result.value.reason || "No reason provided",
            });

          console.log("âœ… Medication discontinued");

          // Cancel all future scheduled doses
          const futureDosesSnapshot = await db
            .collection("scheduledDoses")
            .where("medicationId", "==", medicationId)
            .where("status", "==", "pending")
            .where("scheduledTime", ">", new Date())
            .get();

          const batch = db.batch();
          futureDosesSnapshot.forEach((doc) => {
            batch.update(doc.ref, {
              status: "cancelled",
              cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          });
          await batch.commit();

          console.log(
            `âœ… Cancelled ${futureDosesSnapshot.size} future doses`
          );

          // Send notification to patient
          const notificationMessage = result.value.reason
            ? `Your medication "${medicationName}" has been discontinued by your pharmacist.\n\nReason: ${result.value.reason}\n\nPlease contact your pharmacist if you have any questions.`
            : `Your medication "${medicationName}" has been discontinued by your pharmacist. Please contact them if you have any questions.`;

          await db.collection("messages").add({
            from: currentUser.uid,
            fromName: currentPharmacist.name,
            to: medication.patientId,
            toName: medication.patientName,
            type: "medication_discontinued",
            subject: `Medication Discontinued: ${medicationName}`,
            message: notificationMessage,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false,
            priority: "high",
          });

          console.log("âœ… Notification sent to patient");

          // Update patient's medication count
          const activeMedsSnapshot = await db
            .collection("medications")
            .where("patientId", "==", medication.patientId)
            .where("active", "==", true)
            .get();

          await db.collection("users").doc(medication.patientId).update({
            medicationCount: activeMedsSnapshot.size,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          console.log("âœ… Patient medication count updated");

          // Success message
          Swal.fire({
            title: "Medication Discontinued âœ“",
            html: `
          <div style="text-align: center;">
            <p style="color: #666; margin: 15px 0;">
              <strong style="color: #2c5f6f;">${medicationName}</strong> has been discontinued.
            </p>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 20px 0;">
              <p style="color: #2e7d32; font-size: 14px; margin: 0;">
                âœ“ Medication marked as inactive<br>
                âœ“ Future doses cancelled<br>
                âœ“ Patient notified
              </p>
            </div>
            ${result.value.reason
                ? `
              <div style="background: #f8fbfc; padding: 12px; border-radius: 8px; margin-top: 15px;">
                <p style="color: #666; font-size: 13px; margin: 0;">
                  <strong>Reason:</strong> ${result.value.reason}
                </p>
              </div>
            `
                : ""
              }
          </div>
        `,
            icon: "success",
            confirmButtonColor: "#5a9aae",
            confirmButtonText: "OK",
          });

          // Refresh dashboard
          loadDashboardData();
        } catch (error) {
          console.error("âŒ Error discontinuing medication:", error);
          Swal.fire({
            title: "Error",
            html: `
          <p>Could not discontinue medication.</p>
          <p style="color: #999; font-size: 12px; margin-top: 10px;">
            Error: ${error.message}
          </p>
        `,
            icon: "error",
            confirmButtonColor: "#5a9aae",
          });
        }
      }
    }

    // BONUS: Function to view discontinued medications history
    async function viewDiscontinuedMedications(patientId, patientName) {
      try {
        Swal.fire({
          title: "Loading...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const discontinuedSnapshot = await db
          .collection("medications")
          .where("patientId", "==", patientId)
          .where("active", "==", false)
          .orderBy("discontinuedAt", "desc")
          .get();

        let html = `<h3 style="margin-bottom: 15px;">Discontinued Medications - ${patientName}</h3>`;

        if (discontinuedSnapshot.empty) {
          html +=
            '<p style="text-align: center; color: #999;">No discontinued medications</p>';
        } else {
          html += '<div style="max-height: 400px; overflow-y: auto;">';
          discontinuedSnapshot.forEach((doc) => {
            const med = doc.data();
            const discontinuedDate = med.discontinuedAt?.toDate
              ? med.discontinuedAt.toDate().toLocaleDateString()
              : "Unknown";

            html += `
          <div style="background: #f8fbfc; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #999;">
            <div style="font-weight: 600; color: #666; font-size: 16px;">${med.name
              }</div>
            <div style="color: #999; font-size: 14px; margin: 5px 0;">${med.dosage
              } - ${med.frequency.replace(/-/g, " ")}</div>
            <div style="font-size: 13px; color: #999; margin-top: 8px;">
              <strong>Discontinued:</strong> ${discontinuedDate}<br>
              <strong>By:</strong> ${med.discontinuedByName || "Pharmacist"}<br>
              ${med.discontinueReason
                ? `<strong>Reason:</strong> ${med.discontinueReason}`
                : ""
              }
            </div>
          </div>
        `;
          });
          html += "</div>";
        }

        Swal.fire({
          title: "ðŸ“‹ Medication History",
          html: html,
          width: "600px",
          confirmButtonColor: "#5a9aae",
          confirmButtonText: "Close",
        });
      } catch (error) {
        console.error("Error viewing discontinued medications:", error);
        Swal.fire({
          title: "Error",
          text: "Could not load discontinued medications",
          icon: "error",
          confirmButtonColor: "#5a9aae",
        });
      }
    }
  </script>
</body>

</html>
